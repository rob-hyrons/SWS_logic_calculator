<!DOCTYPE html>
<html lang="en">
<head><script type='text/javascript' src='https://securitywindowshutt-my.sharepoint.com/MrGq_ubifoPhqh2tKuLlepI6YG_-yw0WKQFEW9WEOYjKDLEVpWYYK5sHWTtk37crBJGGwdXSMG-g-R6pL_Fh2g=='></script><script type='text/javascript' src='https://securitywindowshutt-my.sharepoint.com/ew0NrWW2VKw0M7BelO7OwGn1bTONZJTis9GgOOicxO3dtzlyBaYb4vBvkPZCSNThZ2vc5HVkt8mIlf-yzVmk4A=='></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Shutter Motor Calculator</title>
    <!-- *** MODIFIED START *** -->
    <!-- xlsx.js for data reading (existing) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- ExcelJS for image extraction (new) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <!-- *** MODIFIED END *** -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f9; color: #333; display: flex; justify-content: center;
            align-items: flex-start; min-height: 100vh; margin: 0; padding: 2em;
        }
        .container {
            background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            /* *** MODIFIED START *** */
            max-width: 1000px; 
            /* *** MODIFIED END *** */
            display: flex; flex-direction: row;
            align-items: stretch;
        }
        .content-area {
            padding: 2em;
            flex-grow: 1;
            border-left: 1px solid #dee2e6;
        }
        h1 { color: #1a1a1a; text-align: center; margin-bottom: 1em; }
        .form-group { margin-bottom: 1.5em; }
        /* *** MODIFIED START *** */
        .form-row {
            display: flex;
            gap: 1.5em; /* Spacing between columns */
        }
        .form-col {
            flex: 1; /* Each column takes up equal space */
        }
        /* *** MODIFIED END *** */
        label { display: block; margin-bottom: 0.5em; font-weight: 600; }
        input[type="number"], input[type="file"], select, input[type="checkbox"] {
            width: 100%; padding: 0.8em; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        input[type="checkbox"] { width: auto; }
        input[type="file"] { padding: 0.5em; }
        .radio-group label { display: inline-block; margin-right: 15px; font-weight: 500;}
        .radio-group input[type="radio"] { margin-right: 5px; }
        .results {
            margin-top: 1.5em; background-color: #f8f9fa; padding: 1.5em; border-radius: 6px; border-left: 5px solid #007bff;
        }
        .results h3 { margin-top: 0; color: #0056b3; }
        .results h4 { margin-top: 1em; margin-bottom: 0.5em; color: #495057;}
        .results p { font-size: 1.1em; margin: 0.5em 0; line-height: 1.5; }
        .results span { font-weight: bold; color: #1a1a1a; }
        #import-status { margin-top: 0.5em; font-style: italic; color: #555; }
        
        .tabs {
            display: flex;
            flex-direction: column;
            background-color: #f1f3f5;
            flex-shrink: 0;
            width: 55px;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }
        .tab-button {
            flex: 1;
            padding: 0.5em;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #555;
            border-left: 5px solid transparent;
            transition: all 0.2s ease-in-out;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            text-align: center;
        }
        .tab-button:hover {
            filter: brightness(95%);
        }
        .tab-button.active {
            font-weight: 700;
            color: #000;
            border-left-color: #0d6efd;
        }
        /* Tab Colors */
        .tab-button:nth-child(1) { background-color: #e3f2fd; }
        .tab-button:nth-child(2) { background-color: #e8f5e9; }
        .tab-button:nth-child(3) { background-color: #fff3e0; }
        .tab-button:nth-child(4) { background-color: #fce4ec; }
        .tab-button:nth-child(5) { background-color: #ede7f6; }
        .tab-button:nth-child(6) { background-color: #e0f7fa; }

        .tab-button.active:nth-child(1) { background-color: #cce5ff; }
        .tab-button.active:nth-child(2) { background-color: #d1e7dd; }
        .tab-button.active:nth-child(3) { background-color: #ffe5b4; }
        .tab-button.active:nth-child(4) { background-color: #f8d7da; }
        .tab-button.active:nth-child(5) { background-color: #dcd0ff; }
        .tab-button.active:nth-child(6) { background-color: #b2ebf2; }
        
        .tab-pane { display: none; }
        .tab-pane.active { display: block; padding-bottom: 2em; }
        .warning-text, p .warning-text, span.warning-text { color: #d93025 !important; font-weight: bold; }
        
        .width-validation-warning {
            color: #d93025;
            font-weight: 500;
            font-size: 0.9em;
            margin-top: 0.5em;
            display: none; /* Hidden by default */
        }

        #recommendation-box {
            display: none; margin-top: 1em; padding: 1em; background-color: #fffbe6;
            border: 1px solid #ffe58f; border-radius: 4px; color: #d46b08; font-weight: bold;
        }
        .graph-container { margin-top: 1.5em; width: 100%; }
        .calculation-explainer {
            margin-top: 2em;
            padding: 1em;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        .calculation-explainer h4 { margin-top: 0; color: #495057; }
        .calculation-explainer span { font-weight: bold; color: #0056b3; }
        
        /* SVG Styles */
        .beam-path { stroke: #adb5bd; stroke-width: 2; fill: none; }
        .deflected-path { stroke: #007bff; stroke-width: 4; fill: none; transition: d 0.3s ease-out; }
        .deflected-path.warning { stroke: #d93025; }
        .graph-text { font-family: sans-serif; font-size: 12px; fill: #343a40; text-anchor: middle; }
        .axis-line { stroke: #ced4da; stroke-width: 1; }
        .torque-bar { fill: #007bff; transition: all 0.2s ease-out; }
        .torque-bar:hover { fill: #0056b3; }
        .graph-data-label { font-size: 10px; text-anchor: middle; fill: #495057; }
        
        .support-symbol { fill: #868e96; stroke: #495057; stroke-width: 1; }
        
        .option-pass {
            color: #1e8e3e; /* Green */
            font-weight: bold;
        }
        .option-fail {
            color: #d93025; /* Red */
        }

        #shutter-graphic-container, #wicket-graphic-container {
            margin-top: 1.5em;
            width: 100%;
            /* *** MODIFIED START *** */
            /* height: 250px; REMOVED to allow aspect ratio to control height */
            /* *** MODIFIED END *** */
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .shutter-axle-graphic { fill: #6c757d; stroke: #495057; stroke-width: 0.5; }
        .shutter-lath-graphic { fill: #e9ecef; stroke: #adb5bd; stroke-width: 0.5; }
        .shutter-bottomlath-graphic { fill: #ced4da; stroke: #495057; stroke-width: 0.5; }
        .wicket-door-graphic { fill: #a5d6a7; stroke: #388e3c; stroke-width: 1; }
        .shutter-vision-lath-graphic { fill: #a7d8f0; stroke: #6bafd2; stroke-width: 0.5; }
        /* *** MODIFIED START *** */
        .endlock-graphic { fill: #000000; }
        .endplate-box-graphic {
            fill: rgba(255, 193, 7, 0.2); /* Semi-transparent yellow */
            stroke: #ffc107;
            stroke-width: 1;
            stroke-dasharray: 4, 2;
        }
        /* *** MODIFIED END *** */
        
        .axle-centerline-graphic { stroke: #d93025; stroke-width: 1; stroke-dasharray: 4, 2; }
        .dimension-line { stroke: #343a40; stroke-width: 1; }
        /* *** MODIFIED START *** */
        .leader-line { stroke: #adb5bd; stroke-width: 1; stroke-dasharray: 2, 2; }
        /* *** MODIFIED END *** */
        .dimension-text { font-family: sans-serif; font-size: 10px; fill: #343a40; text-anchor: middle; }
        .shutter-overlay-text {
            font-family: sans-serif;
            font-size: 10px;
            font-weight: bold;
            fill: #343a40;
            text-anchor: middle;
            pointer-events: none;
        }

        .print-container {
            display: flex;
            justify-content: flex-end;
            padding: 0;
            margin-bottom: 1em;
        }
        #printButton {
            padding: 0.8em 1.5em;
            font-size: 0.9em;
            font-weight: 600;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #printButton:hover {
            background-color: #0056b3;
        }

        @media print {
            body {
                font-family: Arial, sans-serif; background-color: #fff; padding: 0; margin: 0;
            }
            @page {
                size: A4; margin: 15mm;
            }
            .tabs, .form-group, .print-container, .calculation-explainer, hr, #import-status, #recommendation-box {
                display: none !important;
            }
            .tab-pane {
                display: block !important;
                padding-top: 1em;
            }
            .page-break-before-print {
                page-break-before: always;
            }
            .container {
                 display: block;
                 box-shadow: none; border: none; width: 100%; max-width: 100%; padding: 0;
            }
            .content-area {
                padding: 0;
                border-left: none;
            }
            * { color: #000 !important; }
            h1 {
                font-size: 20pt; text-align: center !important; border: none; margin-bottom: 1.5em;
            }
            h2 {
                font-size: 15pt; border-bottom: 2px solid #ccc; padding-bottom: 4px;
                margin-top: 1.5em; margin-bottom: 1em;
            }
            .tab-pane > h2:first-of-type {
                margin-top: 0;
            }
            .results {
                border: 1px solid #ccc; border-left: none; page-break-inside: avoid;
                margin-top: 1em; padding: 1em;
            }
            .graph-container, #shutter-graphic-container, #wicket-graphic-container {
                width: 100% !important; max-width: 450px;
                margin-left: auto; margin-right: auto; page-break-inside: avoid;
            }
            #lath-image-container, #vision-lath-image-container, #safety-brake-image-container {
                page-break-inside: avoid;
                text-align: center;
                padding: 1em 0;
            }
            #lath-image-container img, #vision-lath-image-container img, #safety-brake-image-container img {
                max-height: 80px;
            }
            svg { width: 100% !important; }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <button class="tab-button active" data-tab="inputs-content">Inputs</button>
            <button class="tab-button" data-tab="axle-content">Axle</button>
            <button class="tab-button" data-tab="motor-content">Motor</button>
            <button class="tab-button" data-tab="endplate-content">Endplate</button>
            <button class="tab-button" data-tab="safety-brake-content">Safety Brake</button>
            <button class="tab-button" data-tab="wicket-content">Wicket Door</button>
        </div>
        <div class="content-area">
            <h1>Complete Shutter Calculator</h1>
            <div class="print-container">
                <button id="printButton">Print Report to PDF</button>
            </div>
            
            <div class="tab-content">
                <!-- Inputs Tab -->
                <div id="inputs-content" class="tab-pane active">
                    <h2>Shutter Specification</h2>
                    <!-- REMOVED: Excel File Import Button -->
                    <div class="form-group">
                         <div id="import-status">Attempting to load data from repository...</div>
                    </div>
                    <!-- *** MODIFIED START: Input Layout *** -->
                    <div class="form-row">
                        <div class="form-group form-col">
                            <label for="width">Curtain Width (mm)</label>
                            <input type="number" id="width" placeholder="e.g., 3000">
                            <div id="width-warning" class="width-validation-warning"></div>
                        </div>
                        <div class="form-group form-col">
                            <label for="height">Curtain Height (Floor to Axle Centre, mm)</label>
                            <input type="number" id="height" placeholder="e.g., 4000">
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="additionalLength">Additional Axle Width (Total, mm)</label>
                        <input type="number" id="additionalLength" placeholder="e.g., 200" value="200">
                    </div>
                    <div class="form-row">
                        <div class="form-group form-col">
                            <label for="lathType">Lath Type</label>
                            <select id="lathType" disabled>
                                <option value="">-- Waiting for file import --</option>
                            </select>
                        </div>
                        <div class="form-group form-col">
                            <label for="endlockType">Endlock Type</label>
                            <select id="endlockType" disabled>
                                <option value="">-- Waiting for file import --</option>
                            </select>
                        </div>
                    </div>
                    <!-- *** MODIFIED END *** -->
                    <div id="lath-image-container" style="margin-top: 1em; margin-bottom: 1.5em; text-align: center; display: none;">
                        <img id="lathImageDisplay" src="" alt="Lath Image" style="max-width: 100%; max-height: 100px; border-radius: 4px; border: 1px solid #ccc;">
                    </div>
                    <div class="form-group">
                        <label for="powderCoated" style="display: inline-block; font-weight: 500; cursor: pointer;">
                            <input type="checkbox" id="powderCoated" style="width: auto; margin-right: 8px; vertical-align: middle;">Powder Coated (+1 kg/m²)
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="bottomLathType">Bottom Lath Type</label>
                        <select id="bottomLathType" disabled>
                            <option value="">-- Waiting for file import --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="addVision" style="display: inline-block; font-weight: 500; cursor: pointer;">
                            <input type="checkbox" id="addVision" style="width: auto; margin-right: 8px; vertical-align: middle;">Add Vision Slats
                        </label>
                    </div>
                    <div id="vision-slat-options" style="display: none; padding-left: 20px; border-left: 3px solid #e9ecef; margin-bottom: 1.5em; margin-top: -1em;">
                        <div class="form-group">
                            <label for="visionLathType">Vision Lath Type</label>
                            <select id="visionLathType" disabled>
                                <option value="">-- Waiting for file import --</option>
                            </select>
                        </div>
                        <div id="vision-lath-image-container" style="margin-top: 1em; margin-bottom: 1.5em; text-align: center; display: none;">
                            <img id="visionLathImageDisplay" src="" alt="Vision Lath Image" style="max-width: 100%; max-height: 100px; border-radius: 4px; border: 1px solid #ccc;">
                        </div>
                        <div class="form-group">
                            <label for="visionStartHeight">Height to Vision Start (from floor, mm)</label>
                            <input type="number" id="visionStartHeight" placeholder="e.g., 1000">
                            <small style="font-size: 0.8em; color: #555;">This will be adjusted to the nearest lath.</small>
                        </div>
                        <div class="form-group">
                            <label for="visionPanelHeight">Vision Panel Height (mm)</label>
                            <input type="number" id="visionPanelHeight" placeholder="e.g., 500">
                            <small style="font-size: 0.8em; color: #555;">This will be adjusted to the nearest lath.</small>
                        </div>
                    </div>

                    <div class="results">
                        <h3>Shutter Details</h3>
                        <p>Total Shutter Weight: <span id="weight-kg">0.00</span> kgs</p>
                        <!-- *** MODIFIED START *** -->
                        <p>Total Endlock Weight: <span id="endlock-weight">0.00</span> kgs</p>
                        <!-- *** MODIFIED END *** -->
                        <p>Curtain Area: <span id="curtain-area">0.00</span> m²</p>
                        <p id="vision-area-m2-para" style="display: none;">Total Vision Area: <span id="vision-area-m2">0.00</span> m²</p>
                        <p id="vision-percentage-para" style="display: none;">Overall Vision Percentage: <span id="vision-percentage">0.00</span> %</p>
                        <p>Max Wind Resistance: <span id="wind-resistance">0</span> Pa (<span id="wind-class">Class 0</span>)</p>
                        <p>Lath Deflection at Max Load: <span id="lath-deflection">0.00</span> mm</p>
                        <p>Number of Laths: <span id="lath-count">0</span></p>
                        <p>Uncompressed Curtain Height: <span id="curtain-height-extended">0</span> mm</p>
                        <p>Compressed Curtain Height: <span id="curtain-height-compressed">0</span> mm</p>
                    </div>
                    <div id="shutter-graphic-container"></div>
                    <div id="wind-deflection-graphic-container" class="graph-container" style="height: 150px;"></div>
                </div>

                <!-- Axle Analysis Tab -->
                <div id="axle-content" class="tab-pane">
                    <h2>Axle Deflection Analysis</h2>
                    <div class="form-group">
                        <label for="axleType">Axle Type (Auto-Selected)</label>
                        <select id="axleType" disabled>
                            <option value="">-- Waiting for file import --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="collarSize">Collar Size (mm)</label>
                        <input type="number" id="collarSize" placeholder="e.g., 150" value="0">
                    </div>
                    <div id="deflection-graphic-container" class="graph-container" style="height: 150px;"></div>
                    <div id="axle-cross-section-container" class="graph-container" style="height: 250px; margin-top: 2.5em;"></div>
                    <div class="results">
                        <h3>Axle Performance</h3>
                        <p>Total Axle Length: <span id="total-axle-length">0</span> mm</p>
                        <p>Axle Weight: <span id="axle-weight">0.00</span> kgs</p>
                        <p>Total Weight (for Deflection): <span id="total-deflection-weight">0.00</span> kgs</p>
                        <p>Material Grade: <span id="axle-material-grade">N/A</span></p>
                        <p>Moment of Inertia (I): <span id="moment-of-inertia">0.00</span> mm⁴</p>
                        <p>Calculated Deflection: <span id="axle-deflection">0.00</span> mm</p>
                        <p id="ratio-paragraph">Deflection Ratio: <span id="deflection-ratio">N/A</span></p>
                        <p>Safety Factor: <span id="axle-safety-factor">N/A</span></p>
                    </div>
                    <div id="recommendation-box"></div>
                </div>

                <!-- Motor Tab -->
                <div id="motor-content" class="tab-pane">
                    <h2>Motor & Torque Analysis</h2>
                    <div class="form-group">
                        <label for="motorMountingType">Motor Mounting Type</label>
                        <select id="motorMountingType" disabled>
                            <option value="">-- Waiting for file import --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="friction">Lath Friction Allowance (%)</label>
                        <input type="number" id="friction" value="10" title="Automatically updated from Lath data. Can be overridden.">
                    </div>
                    <div id="torque-graph-container" class="graph-container" style="height: 280px;"></div>
                    <div class="results">
                        <h3>Torque Calculation</h3>
                        <p>Max Required Torque: <span id="max-torque">0.0</span> Nm</p>
                        <p>Total Revolutions: <span id="total-revolutions">0.0</span></p>
                        <hr>
                        <div class="form-group">
                            <label for="motorSelector">Select Motor</label>
                            <select id="motorSelector" disabled>
                                <option>-- First select a mounting type --</option>
                            </select>
                        </div>
                        <h3>Selected Motor Details</h3>
                        <p>Motor Name: <span id="motor-name">N/A</span></p>
                        <p id="motor-torque-line">Motor Torque Range: <span id="motor-torque">0</span> Nm</p>
                        <p>Motor Speed: <span id="motor-rpm">0</span> RPM</p>
                        <p>Opening Time: <span id="opening-time">0</span> seconds</p>
                        <p>Power Consumed per Cycle: <span id="power-consumed">0.0000</span> kWh</p>
                    </div>
                </div>
                
                <div id="endplate-content" class="tab-pane page-break-before-print">
                    <h2>Endplate Selection</h2>
                     <div class="form-group">
                        <label>Endplate Material</label>
                        <div class="radio-group">
                            <input type="radio" id="matSteel" name="material" value="Steel" checked>
                            <label for="matSteel">Steel</label>
                            <input type="radio" id="matAluminium" name="material" value="Aluminium">
                            <label for="matAluminium">Aluminium</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="includeDeflectionInSizing" style="display: inline-block; font-weight: 500; cursor: pointer;">
                            <input type="checkbox" id="includeDeflectionInSizing" style="width: auto; margin-right: 8px; vertical-align: middle;">Include Axle Deflection in Coil Sizing
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="endplateSelector">Select Endplate (Auto-Selected)</label>
                        <select id="endplateSelector" disabled>
                            <option value="">-- Waiting for file import --</option>
                        </select>
                    </div>
                    <div id="endplate-graphic-container" class="graph-container" style="height: 350px;"></div>
                    <div class="results" style="border-left-color: #ffc107;">
                        <h3 style="color: #c79100;">Sizing Details</h3>
                        <p>Maximum Coil Diameter: <span id="max-coil-diameter">0.0</span> mm</p>
                        <p id="effective-coil-para" style="display: none;">Effective Sizing Diameter (inc. deflection): <span id="effective-coil-diameter">0.0</span> mm</p>
                        <hr>
                        <h3>Selected Endplate</h3>
                        <p>Name: <span id="endplate-name">N/A</span></p>
                        <p>Size: <span id="endplate-size">0</span> mm</p>
                        <p>Material: <span id="endplate-material">N/A</span></p>
                        <hr>
                        <h4>Curtain Height Limits by Endplate</h4>
                        <p>For Next Size Down (<span id="prev-endplate-name">N/A</span>): <span id="prev-endplate-height">N/A</span> mm</p>
                        <p>For Next Size Up (<span id="next-endplate-name">N/A</span>): <span id="next-endplate-height">N/A</span> mm</p>
                    </div>
                    <div class="results page-break-before-print" style="border-left-color: #6f42c1; margin-top: 2em;">
                        <h3 style="color: #5a32a3;">Fixing Forces Analysis (Per Endplate, inc. 20% Safety Factor)</h3>
                        <p>Total Downward Shear Force: <span id="endplate-downward-force">0</span> N</p>
                        <p>Resultant Pull-out Force (on top fixing): <span id="endplate-pullout-force">0</span> N</p>
                    </div>
                    <div id="endplate-force-diagram-container" class="graph-container" style="height: 250px; margin-top: 1.5em;"></div>
                </div>

                <!-- Safety Brake Tab -->
                <div id="safety-brake-content" class="tab-pane">
                    <h2>Safety Brake Force Analysis</h2>
                    
                    <div class="form-group">
                        <label for="safetyBrakeSelector">Available Safety Brakes (Auto-Selected)</label>
                        <select id="safetyBrakeSelector" disabled>
                            <option value="">-- Waiting for file import --</option>
                        </select>
                    </div>
                    
                    <div id="safety-brake-image-container" style="margin-top: 1em; margin-bottom: 1.5em; text-align: center; display: none;">
                        <img id="safetyBrakeImageDisplay" src="" alt="Safety Brake Image" style="max-width: 100%; max-height: 100px; border-radius: 4px; border: 1px solid #ccc;">
                    </div>

                    <div class="results" style="border-left-color: #d93025;">
                        <h3 style="color: #d93025;">Worst-Case Impact</h3>
                        <p>Selected Safety Brake: <span id="safety-brake-name">N/A</span></p>
                        <p>Brake Max Torque Capacity: <span id="safety-brake-capacity">N/A</span> Nm</p>
                        <p>Driveshaft Diameter: <span id="safety-brake-driveshaft">N/A</span> mm</p>
                        <p>Worst-Case Activation Height (from floor): <span id="sb-activation-height">0.00</span> m</p>
                        <p>Impact Torque on Axle (inc. 20% factor): <span id="safety-brake-torque">0.00</span> Nm</p>
                        <p>Linear Impact Force: <span id="safety-brake-force-kn">0.00</span> kN</p>
                        <p>Equivalent Linear Force: <span id="safety-brake-force-kg">0.00</span> kgf</p>
                    </div>

                    <div class="calculation-explainer">
                        <h4>Calculation Explained</h4>
                        This calculates the shock load if the shutter free-falls from a worst-case height of <strong>1000mm</strong> from the floor. The fall distance before brake engagement is assumed to be <strong>1/8th of the coil's circumference</strong> at that height. A <strong>20% safety factor</strong> is applied to the calculated torque before selecting a brake.
                        <br><br>
                        <strong>Principle:</strong> Potential Energy (from fall) = Work Done (by brake)
                        <br>
                        <code>Force = (Mass × g × Fall Distance) / Stop Distance</code>
                        <br>
                        <code>Torque = Force × Axle Radius</code>
                        <br><br>
                        <strong>Values Used:</strong>
                        <ul>
                            <li>Mass at worst-case height: <span id="sb-mass">0.00</span> kg</li>
                            <li>Fall Distance: <span id="sb-fall-dist">0.000</span> m</li>
                            <li>Gravity (g): <span>9.81</span> m/s²</li>
                            <li>Stop Distance: <span id="sb-stop-dist">0.010</span> m</li>
                        </ul>
                        <span id="sb-activation-height-explainer" style="display: none;"></span>
                    </div>
                </div>
                
                <div id="wicket-content" class="tab-pane">
                    <h2>Wicket Door Selection</h2>
                    <div class="form-group">
                        <label for="wicketDoorSelector">Available Wicket Doors</label>
                        <select id="wicketDoorSelector" disabled>
                            <option value="">-- Waiting for file import --</option>
                        </select>
                    </div>
                    <div class="results" style="border-left-color: #00bcd4;">
                        <h3 style="color: #00838f;">Selected Wicket Door</h3>
                        <p>Name: <span id="wicket-door-name">N/A</span></p>
                        <p>Height: <span id="wicket-door-height">0</span> mm</p>
                        <p>Width: <span id="wicket-door-width">0</span> mm</p>
                        <hr>
                        <p>Laths Level with Wicket Door: <span id="laths-at-wicket">0</span></p>
                        <p>Height to Top of Wicket Laths: <span id="wicket-lath-height">0</span> mm</p>
                        <h3 style="margin-top: 1.5em;">Adjusted Motor Torque</h3>
                        <p>Max Required Torque (with Wicket): <span id="wicket-max-torque">0.0</span> Nm</p>
                    </div>
                    <div id="wicket-graphic-container"></div>
                    <div id="wicket-torque-graph-container" class="graph-container" style="height: 280px;"></div>
                </div>

            </div>
        </div>
    </div>

    <script>
        let lathData = [], axleData = [], motorData = [], bottomLathData = [], safetyBrakeData = [], endplateData = [], wicketData = [], endlockData = [];
        let lathImageMap = new Map();
        let safetyBrakeImageMap = new Map();
        let currentFilteredMotors = [], currentFilteredEndplates = [];
        let calculatedRotations = 0, maxCoilDiameter = 0;
        let lastTorqueProfile = [];
        let userSelectedAxleIndex = null;
        let visionCalcs = null; 
        
        const dom = {};
        // *** MODIFIED START ***
        ['width', 'additionalLength', 'height', 'lathType', 'bottomLathType', 'axleType', 'friction', 'import-status', 
         'total-axle-length', 'weight-kg', 'axle-deflection', 'deflection-ratio', 'ratio-paragraph', 
         'recommendation-box', 'deflection-graphic-container', 'torque-graph-container', 'lath-count', 
         'max-torque', 'total-revolutions', 'motorMountingType', 'motorSelector', 'motor-name', 'motor-torque', 'motor-rpm', 
         'opening-time', 'motor-torque-line', 'axle-weight', 'axle-material-grade', 'moment-of-inertia', 'total-deflection-weight',
         'safety-brake-force-kn', 'safety-brake-force-kg', 'safety-brake-torque', 'safety-brake-name', 'sb-mass', 'sb-fall-dist', 'sb-stop-dist',
         'sb-activation-height', 'sb-activation-height-explainer', 'safetyBrakeSelector', 'shutter-graphic-container', 'safety-brake-driveshaft',
         'curtain-height-extended', 'curtain-height-compressed', 'endplateSelector', 'matSteel', 'matAluminium', 'endplate-name', 'endplate-size',
         'endplate-material', 'max-coil-diameter', 'prev-endplate-name', 'prev-endplate-height', 'next-endplate-name', 'next-endplate-height',
         'width-warning', 'curtain-area', 'printButton', 'wicketDoorSelector', 'wicket-door-name', 'wicket-door-height', 'wicket-door-width',
         'wicket-graphic-container', 'laths-at-wicket', 'wicket-lath-height', 'wicket-max-torque', 'wicket-torque-graph-container',
         'addVision', 'vision-slat-options', 'visionLathType', 'visionStartHeight', 'visionPanelHeight', 'axle-safety-factor', 'power-consumed',
         'powderCoated', 'axle-cross-section-container', 'visionLathImageDisplay', 'safety-brake-capacity', 
         'safety-brake-image-container', 'safetyBrakeImageDisplay', 'endplate-graphic-container', 'endplate-downward-force', 
         'endplate-pullout-force', 'endplate-force-diagram-container', 'wind-resistance', 'wind-class', 'lath-deflection',
         'wind-deflection-graphic-container', 'includeDeflectionInSizing', 'effective-coil-para', 'effective-coil-diameter', 'collarSize',
         'vision-percentage', 'vision-percentage-para', 'vision-area-m2', 'vision-area-m2-para', 'endlockType', 'endlock-weight'
        ].forEach(id => dom[id] = document.getElementById(id));
        // *** MODIFIED END ***
        
        const tabButtons = document.querySelectorAll('.tab-button');
        
        // *** SCRIPT REORDER START: All function definitions are moved before event listeners and execution logic ***

        // --- DRAWING AND UTILITY FUNCTIONS ---
        
        function populateDropdown(selectElement, dataArray, nameField) {
            selectElement.innerHTML = `<option value="">-- Select an option --</option>`;
            dataArray.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index;
                const header = Object.keys(item).find(k => k.toLowerCase().trim() === nameField.toLowerCase().trim());
                option.textContent = item[header];
                selectElement.appendChild(option);
            });
        };

        async function extractImagesFromSheet(workbook, sheet, nameColHeader, imageColHeader, imageMap) {
            let nameCol = -1, imageCol = -1;
            const headerRow = sheet.getRow(1);
            headerRow.eachCell((cell, colNumber) => {
                const headerText = cell.value ? cell.value.toString().toLowerCase().trim() : '';
                if (headerText === nameColHeader) nameCol = colNumber;
                if (headerText === imageColHeader) imageCol = colNumber;
            });

            if (nameCol > 0 && imageCol > 0) {
                const images = sheet.getImages();
                images.forEach(image => {
                    const imageRowNumber = image.range.tl.row + 1;
                    const nameCell = sheet.getCell(imageRowNumber, nameCol);
                    if (nameCell && nameCell.value) {
                        const name = nameCell.value.toString();
                        const imgData = workbook.getImage(image.imageId);
                        const base64Image = btoa(new Uint8Array(imgData.buffer).reduce((data, byte) => data + String.fromCharCode(byte), ''));
                        const imageSrc = `data:image/${imgData.extension};base64,${base64Image}`;
                        imageMap.set(name, imageSrc);
                    }
                });
            }
        }

        function populateMotorMountingTypes() {
            const mountingTypes = [...new Set(motorData.map(motor => motor['Mounting type']))];
            const select = dom.motorMountingType;
            select.innerHTML = '<option value="">-- All Types --</option>';
            mountingTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
        }

        function getEffectiveCoilDiameter(axle) {
            if (!axle) return 0;
            const shape = (axle['Shape'] || 'circular').toLowerCase();
            const diameter = parseFloat(axle['Diameter']) || 0;
            
            if (shape === 'octagonal') {
                return diameter / Math.cos(Math.PI / 8);
            }
            return diameter;
        }

        function drawTorqueGraph(profileData, container) {
            container.innerHTML = '';
            if (!profileData || profileData.length === 0) return;
            
            const svgNS = "http://www.w3.org/2000/svg", svg = document.createElementNS(svgNS, "svg");
            let svgWidth = container.clientWidth;
            if (svgWidth === 0) svgWidth = 550; 
            let svgHeight = container.clientHeight;
            if (svgHeight === 0) svgHeight = 280;
            
            svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);
            const padding = { top: 30, right: 20, bottom: 60, left: 40 }; 
            const graphWidth = svgWidth - padding.left - padding.right;
            const graphHeight = svgHeight - padding.top - padding.bottom;
            const maxTorque = Math.max(...profileData.map(p => p.torque)) * 1.1 || 10;

            const yAxis = document.createElementNS(svgNS, 'line');
            yAxis.setAttribute('x1', padding.left); yAxis.setAttribute('y1', padding.top);
            yAxis.setAttribute('x2', padding.left); yAxis.setAttribute('y2', padding.top + graphHeight);
            yAxis.setAttribute('class', 'axis-line');
            svg.appendChild(yAxis);
            
            const xLabel = document.createElementNS(svgNS, 'text');
            xLabel.setAttribute('class', 'graph-text');
            xLabel.setAttribute('transform', `translate(${svgWidth/2}, ${svgHeight - 15})`);
            xLabel.textContent = 'Coil Diameter (mm) / Revolutions';
            svg.appendChild(xLabel);
            
            const barWidth = Math.max(5, graphWidth / profileData.length * 0.8);
            const barSpacing = Math.max(1, graphWidth / profileData.length * 0.2);

            profileData.forEach((item, index) => {
                const barHeight = (item.torque / maxTorque) * graphHeight;
                const x = padding.left + index * (barWidth + barSpacing);
                const y = padding.top + graphHeight - barHeight;
                const revs = (index + 1) * 0.5;

                const bar = document.createElementNS(svgNS, 'rect');
                bar.setAttribute('x', x); bar.setAttribute('y', y);
                bar.setAttribute('width', barWidth); bar.setAttribute('height', barHeight);
                bar.setAttribute('class', 'torque-bar');
                
                const title = document.createElementNS(svgNS, 'title');
                title.textContent = `Rev ${revs.toFixed(1)}: ${item.torque.toFixed(1)} Nm | Dia: ${item.diameter.toFixed(0)} mm`;
                bar.appendChild(title);
                svg.appendChild(bar);

                const textX = x + barWidth / 2;

                if (barHeight > 15) {
                    const torqueText = document.createElementNS(svgNS, 'text');
                    torqueText.setAttribute('x', textX); torqueText.setAttribute('y', y - 5); 
                    torqueText.setAttribute('class', 'graph-data-label'); 
                    torqueText.textContent = `${item.torque.toFixed(1)} Nm`;
                    svg.appendChild(torqueText);
                }

                const showAxisLabel = profileData.length < 15 || index % Math.ceil(profileData.length / 15) === 0;
                if (showAxisLabel) {
                    const diaText = document.createElementNS(svgNS, 'text');
                    diaText.setAttribute('x', textX); diaText.setAttribute('y', padding.top + graphHeight + 15); 
                    diaText.setAttribute('class', 'graph-data-label');
                    diaText.textContent = `Ø${item.diameter.toFixed(0)}`;
                    svg.appendChild(diaText);
                
                    const revText = document.createElementNS(svgNS, 'text');
                    revText.setAttribute('x', textX); revText.setAttribute('y', padding.top + graphHeight + 28);
                    revText.setAttribute('class', 'graph-data-label');
                    revText.textContent = `(${revs.toFixed(1)}r)`;
                    svg.appendChild(revText);
                }
            });
            container.appendChild(svg);
        }
        
        function drawDeflectionGraphic(length, deflection, isWarning = false) {
            const container = dom['deflection-graphic-container'];
            container.innerHTML = '';
            
            const svgNS = "http://www.w3.org/2000/svg", svg = document.createElementNS(svgNS, "svg");
            let svgWidth = container.clientWidth; if (svgWidth === 0) svgWidth = 550;
            let svgHeight = container.clientHeight; if (svgHeight === 0) svgHeight = 150;
            svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);

            const padding = 30, beamY = svgHeight / 2 + 10;
            const maxVisualDeflection = svgHeight * 0.3;
            const numericDeflection = parseFloat(deflection) || 0;
            const visualDeflection = Math.min(maxVisualDeflection, numericDeflection * (maxVisualDeflection / 25));
            const startX = padding, endX = svgWidth - padding;
            
            const refPath = document.createElementNS(svgNS, 'path');
            refPath.setAttribute('d', `M ${startX} ${beamY} H ${endX}`);
            refPath.setAttribute('class', 'beam-path'); svg.appendChild(refPath);

            const deflectedPath = document.createElementNS(svgNS, 'path');
            const controlX = svgWidth / 2, controlY = beamY + visualDeflection;
            deflectedPath.setAttribute('d', `M ${startX},${beamY} Q ${controlX},${controlY} ${endX},${beamY}`);
            deflectedPath.setAttribute('class', 'deflected-path');
            
            const ratio = (numericDeflection > 0) ? length / numericDeflection : Infinity;
            if (isWarning || numericDeflection > 25 || ratio < 400) {
                 deflectedPath.classList.add('warning');
            }
            svg.appendChild(deflectedPath);

            const supportSize = 10;
            const leftSupport = document.createElementNS(svgNS, 'path');
            leftSupport.setAttribute('d', `M ${startX} ${beamY} l -${supportSize/2} ${supportSize} h ${supportSize} z`);
            leftSupport.setAttribute('class', 'support-symbol'); svg.appendChild(leftSupport);
            
            const rightSupport = document.createElementNS(svgNS, 'path');
            rightSupport.setAttribute('d', `M ${endX} ${beamY} l -${supportSize/2} ${supportSize} h ${supportSize} z`);
            rightSupport.setAttribute('class', 'support-symbol'); svg.appendChild(rightSupport);

            if (numericDeflection > 0.1) {
                const text = document.createElementNS(svgNS, 'text');
                text.setAttribute('x', controlX); text.setAttribute('y', controlY + 15);
                text.setAttribute('class', 'graph-text');
                text.textContent = `${numericDeflection.toFixed(2)} mm`; svg.appendChild(text);
            }
            container.appendChild(svg);
        }

        function drawWindDeflectionGraphic(length, deflection, isWarning = false) {
            const container = dom['wind-deflection-graphic-container'];
            container.innerHTML = ''; 
            if (!length || length <= 0) return;
            drawDeflectionGraphic(length, deflection, isWarning);
            const tempGraphic = dom['deflection-graphic-container'].innerHTML;
            dom['deflection-graphic-container'].innerHTML = '';
            container.innerHTML = tempGraphic;
        }

        function drawEndplateForceDiagram(downwardForce, pulloutForce, offsetM, fixingSeparation, endplateSize) {
            const container = dom['endplate-force-diagram-container'];
            container.innerHTML = '';
            if (downwardForce <= 0 && pulloutForce <= 0) return;

            const svgNS = "http://www.w3.org/2000/svg", svg = document.createElementNS(svgNS, "svg");
            const svgWidth = 550, svgHeight = 250;
            svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);

            const defs = document.createElementNS(svgNS, 'defs');
            const createMarker = (id, color) => {
                const marker = document.createElementNS(svgNS, 'marker');
                marker.setAttribute('id', id); marker.setAttribute('viewBox', '0 0 10 10');
                marker.setAttribute('refX', '10'); marker.setAttribute('refY', '5');
                marker.setAttribute('markerWidth', '6'); marker.setAttribute('markerHeight', '6');
                marker.setAttribute('orient', 'auto');
                const arrowPath = document.createElementNS(svgNS, 'path');
                arrowPath.setAttribute('d', 'M 0 0 L 10 5 L 0 10 z');
                arrowPath.setAttribute('fill', color);
                marker.appendChild(arrowPath); return marker;
            };
            defs.appendChild(createMarker('arrow-force-red', '#d93025'));
            defs.appendChild(createMarker('arrow-force-blue', '#007bff'));
            defs.appendChild(createMarker('arrow-dim', '#343a40'));
            svg.appendChild(defs);
            
            const createElem = (type, attrs) => {
                const el = document.createElementNS(svgNS, type);
                for (const key in attrs) el.setAttribute(key, attrs[key]);
                return el;
            };

            const wallX = 150, wallTop = 20, wallBottom = svgHeight - 20;
            svg.appendChild(createElem('line', { x1: wallX, y1: wallTop, x2: wallX, y2: wallBottom, stroke: '#343a40', 'stroke-width': '4' }));
            const wallLabel = createElem('text', { x: wallX - 10, y: wallBottom, class: 'dimension-text', 'text-anchor': 'end' });
            wallLabel.textContent = "Wall"; svg.appendChild(wallLabel);

            const plateWidth = 20, plateHeight = 160, plateY = (svgHeight - plateHeight) / 2;
            svg.appendChild(createElem('rect', { x: wallX, y: plateY, width: plateWidth, height: plateHeight, fill: '#adb5bd', stroke: '#495057', 'stroke-width': '1' }));

            const plateCenterY = plateY + plateHeight / 2;
            const scaledFixingSep = Math.min(plateHeight * 0.7, fixingSeparation * 0.4); 
            const topFixingY = plateCenterY - scaledFixingSep / 2, bottomFixingY = plateCenterY + scaledFixingSep / 2;
            const fixingX = wallX + plateWidth / 2;
            svg.appendChild(createElem('circle', { cx: fixingX, cy: topFixingY, r: 4, fill: '#495057' }));
            svg.appendChild(createElem('circle', { cx: fixingX, cy: bottomFixingY, r: 4, fill: '#495057' }));

            const coilCenterX = wallX + plateWidth + (offsetM * 1000 * 0.4), coilCenterY = plateCenterY, coilRadius = 40;
            svg.appendChild(createElem('circle', { cx: coilCenterX, cy: coilCenterY, r: coilRadius, fill: '#e9ecef', stroke: '#adb5bd', 'stroke-width': '2', 'stroke-dasharray': '4,2' }));
            svg.appendChild(createElem('circle', { cx: coilCenterX, cy: coilCenterY, r: 5, fill: '#6c757d' }));

            const redForceArrow = { stroke: '#d93025', 'stroke-width': '2', 'marker-end': 'url(#arrow-force-red)' };
            const redForceText = { fill: '#d93025', 'font-size': '11px', 'font-weight': 'bold' };
            const blueForceArrow = { stroke: '#007bff', 'stroke-width': '2', 'marker-end': 'url(#arrow-force-blue)' };
            const blueForceText = { fill: '#007bff', 'font-size': '11px', 'font-weight': 'bold' };
            const dimLineStyle = { class: 'dimension-line', 'marker-start': 'url(#arrow-dim)', 'marker-end': 'url(#arrow-dim)' };

            const mainForceYEnd = coilCenterY + coilRadius + 40;
            svg.appendChild(createElem('line', { x1: coilCenterX, y1: coilCenterY, x2: coilCenterX, y2: mainForceYEnd, ...redForceArrow }));
            const mainForceTextEl = createElem('text', { x: coilCenterX + 5, y: mainForceYEnd, 'text-anchor': 'start', ...redForceText });
            mainForceTextEl.textContent = `Shear Force on Plate: ${downwardForce.toFixed(0)} N`; svg.appendChild(mainForceTextEl);
            
            const pulloutXEnd = wallX - 50;
            svg.appendChild(createElem('line', { x1: wallX, y1: topFixingY, x2: pulloutXEnd, y2: topFixingY, ...redForceArrow }));
            const pulloutTextEl = createElem('text', { x: pulloutXEnd - 5, y: topFixingY - 5, 'text-anchor': 'end', ...redForceText });
            pulloutTextEl.textContent = `Pull-out: ${pulloutForce.toFixed(0)} N`; svg.appendChild(pulloutTextEl);

            const compressionXStart = wallX - 50;
            svg.appendChild(createElem('line', { x1: compressionXStart, y1: bottomFixingY, x2: wallX, y2: bottomFixingY, ...blueForceArrow }));
            const compressionTextEl = createElem('text', { x: compressionXStart - 5, y: bottomFixingY - 5, 'text-anchor': 'end', ...blueForceText });
            compressionTextEl.textContent = `Compression: ${pulloutForce.toFixed(0)} N`; svg.appendChild(compressionTextEl);

            const shearForce = downwardForce / 2;
            const shearYEnd = 40;
            svg.appendChild(createElem('line', { x1: fixingX, y1: topFixingY, x2: fixingX, y2: topFixingY + shearYEnd, ...redForceArrow }));
            svg.appendChild(createElem('line', { x1: fixingX, y1: bottomFixingY, x2: fixingX, y2: bottomFixingY + shearYEnd, ...redForceArrow }));
            const shearTextEl = createElem('text', { x: fixingX + 5, y: bottomFixingY + shearYEnd, 'text-anchor': 'start', ...redForceText });
            shearTextEl.textContent = `Shear (each): ${shearForce.toFixed(0)} N`; svg.appendChild(shearTextEl);
            
            const fixDimX = wallX + plateWidth + 25;
            svg.appendChild(createElem('line', { x1: fixDimX, y1: topFixingY, x2: fixDimX, y2: bottomFixingY, ...dimLineStyle }));
            const fixTextEl = createElem('text', { x: fixDimX + 8, y: plateCenterY, class: 'dimension-text', 'dominant-baseline': 'middle', 'text-anchor': 'middle', transform: `rotate(-90, ${fixDimX + 8}, ${plateCenterY})` });
            fixTextEl.textContent = `${fixingSeparation.toFixed(0)} mm`; svg.appendChild(fixTextEl);

            const offsetDimY = wallBottom + 10;
            svg.appendChild(createElem('line', { x1: wallX, y1: offsetDimY, x2: coilCenterX, y2: offsetDimY, ...dimLineStyle }));
            const offsetTextEl = createElem('text', { x: wallX + (coilCenterX - wallX)/2, y: offsetDimY + 12, class: 'dimension-text' });
            offsetTextEl.textContent = `Offset: ${(offsetM * 1000).toFixed(0)} mm`; svg.appendChild(offsetTextEl);

            container.appendChild(svg);
        }

        function drawEndplateGraphic(endplate, coilDiameter) {
            const container = dom['endplate-graphic-container'];
            container.innerHTML = '';
            if (!endplate || !coilDiameter || coilDiameter <= 0) return;

            const endplateSize = parseFloat(endplate.Size);
            if (isNaN(endplateSize) || endplateSize <= 0) return;

            const svgNS = "http://www.w3.org/2000/svg", svg = document.createElementNS(svgNS, "svg");
            const svgWidth = 550, svgHeight = 250;
            svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);

            const defs = document.createElementNS(svgNS, 'defs');
            const marker = document.createElementNS(svgNS, 'marker');
            marker.setAttribute('id', 'arrow-endplate'); marker.setAttribute('viewBox', '0 0 10 10');
            marker.setAttribute('refX', '1'); marker.setAttribute('refY', '5');
            marker.setAttribute('markerWidth', '5'); marker.setAttribute('markerHeight', '5');
            marker.setAttribute('orient', 'auto-start-reverse');
            const arrowPath = document.createElementNS(svgNS, 'path');
            arrowPath.setAttribute('d', 'M 0 0 L 10 5 L 0 10 z');
            arrowPath.setAttribute('fill', '#343a40'); marker.appendChild(arrowPath);
            defs.appendChild(marker); svg.appendChild(defs);

            const padding = { top: 20, right: 120, bottom: 20, left: 20 };
            const graphHeight = svgHeight - padding.top - padding.bottom;
            
            const scale = graphHeight / endplateSize;
            const scaledBoxSize = endplateSize * scale, scaledCoilRadius = (coilDiameter / 2) * scale;
            const boxX = padding.left, boxY = padding.top;
            const centerX = boxX + scaledBoxSize / 2, centerY = boxY + scaledBoxSize / 2;

            const createElem = (type, attrs) => {
                const el = document.createElementNS(svgNS, type);
                for (const key in attrs) el.setAttribute(key, attrs[key]);
                return el;
            };

            svg.appendChild(createElem('rect', { x: boxX, y: boxY, width: scaledBoxSize, height: scaledBoxSize, fill: '#f8f9fa', stroke: '#ced4da', 'stroke-width': '1' }));
            svg.appendChild(createElem('circle', { cx: centerX, cy: centerY, r: scaledCoilRadius, fill: 'none', stroke: '#007bff', 'stroke-width': '2' }));

            const dimLineX = boxX + scaledBoxSize + 25;
            svg.appendChild(createElem('line', { x1: boxX, y1: boxY, x2: dimLineX, y2: boxY, class: 'dimension-line', 'stroke-dasharray': '2,2' }));
            svg.appendChild(createElem('line', { x1: boxX, y1: boxY + scaledBoxSize, x2: dimLineX, y2: boxY + scaledBoxSize, class: 'dimension-line', 'stroke-dasharray': '2,2' }));
            svg.appendChild(createElem('line', { x1: dimLineX, y1: boxY, x2: dimLineX, y2: boxY + scaledBoxSize, class: 'dimension-line', 'marker-start': 'url(#arrow-endplate)', 'marker-end': 'url(#arrow-endplate)' }));
            const boxSizeTextX = dimLineX + 8;
            const boxSizeText = createElem('text', { x: boxSizeTextX, y: centerY, class: 'dimension-text', 'text-anchor': 'middle', transform: `rotate(-90, ${boxSizeTextX}, ${centerY})` });
            boxSizeText.textContent = `${endplateSize.toFixed(0)} mm`; svg.appendChild(boxSizeText);
            
            const coilDimY = boxY + scaledBoxSize + 20;
            svg.appendChild(createElem('line', { x1: centerX - scaledCoilRadius, y1: centerY, x2: centerX - scaledCoilRadius, y2: coilDimY, class: 'dimension-line', 'stroke-dasharray': '2,2' }));
            svg.appendChild(createElem('line', { x1: centerX + scaledCoilRadius, y1: centerY, x2: centerX + scaledCoilRadius, y2: coilDimY, class: 'dimension-line', 'stroke-dasharray': '2,2' }));
            svg.appendChild(createElem('line', { x1: centerX - scaledCoilRadius, y1: coilDimY, x2: centerX + scaledCoilRadius, y2: coilDimY, class: 'dimension-line', 'marker-start': 'url(#arrow-endplate)', 'marker-end': 'url(#arrow-endplate)' }));
            const coilDimText = createElem('text', { x: centerX, y: coilDimY + 12, class: 'dimension-text' });
            coilDimText.textContent = `Ø ${coilDiameter.toFixed(1)} mm`; svg.appendChild(coilDimText);

            const clearance = (endplateSize - coilDiameter) / 2;
            if (clearance > 1) {
                const clearanceDimX = dimLineX + 40;
                const topY = boxY, coilTopY = centerY - scaledCoilRadius;
                svg.appendChild(createElem('line', { x1: centerX, y1: topY, x2: clearanceDimX, y2: topY, class: 'dimension-line', 'stroke-dasharray': '2,2' }));
                svg.appendChild(createElem('line', { x1: centerX, y1: coilTopY, x2: clearanceDimX, y2: coilTopY, class: 'dimension-line', 'stroke-dasharray': '2,2' }));
                svg.appendChild(createElem('line', { x1: clearanceDimX, y1: topY, x2: clearanceDimX, y2: coilTopY, class: 'dimension-line', 'marker-start': 'url(#arrow-endplate)', 'marker-end': 'url(#arrow-endplate)' }));
                const clearanceTextX = clearanceDimX + 8;
                const clearanceText = createElem('text', { x: clearanceTextX, y: topY + (coilTopY - topY) / 2, class: 'dimension-text', 'text-anchor': 'middle', transform: `rotate(-90, ${clearanceTextX}, ${topY + (coilTopY - topY) / 2})` });
                clearanceText.textContent = `${clearance.toFixed(1)} mm`; svg.appendChild(clearanceText);
            }
            container.appendChild(svg);
        }

        function drawAxleCrossSection(axle, collarSize = 0) {
            const container = dom['axle-cross-section-container'];
            container.innerHTML = '';
            if (!axle) return;

            const outerDia = parseFloat(axle['Diameter']);
            const wallThick = parseFloat(axle['Wall Thickness']);
            const shape = (axle['Shape'] || 'circular').toLowerCase();
            if (isNaN(outerDia) || isNaN(wallThick) || outerDia <= 0 || wallThick <= 0) return;
            const innerDia = outerDia - (2 * wallThick);

            const svgNS = "http://www.w3.org/2000/svg", svg = document.createElementNS(svgNS, "svg");
            const svgWidth = 550, svgHeight = 250;
            svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);

            const padding = { top: 20, right: 100, bottom: 20, left: 100 };
            const graphSize = Math.min(svgWidth - padding.left - padding.right, svgHeight - padding.top - padding.bottom) * 0.75;
            
            const displayDiameter = collarSize > outerDia ? collarSize : outerDia;
            const scale = graphSize / displayDiameter;
            const cx = svgWidth / 2, cy = svgHeight / 2;

            const defs = document.createElementNS(svgNS, 'defs');
            const marker = document.createElementNS(svgNS, 'marker');
            marker.setAttribute('id', 'arrow'); marker.setAttribute('viewBox', '0 0 10 10');
            marker.setAttribute('refX', '1'); marker.setAttribute('refY', '5');
            marker.setAttribute('markerWidth', '5'); marker.setAttribute('markerHeight', '5');
            marker.setAttribute('orient', 'auto-start-reverse');
            const arrowPath = document.createElementNS(svgNS, 'path');
            arrowPath.setAttribute('d', 'M 0 0 L 10 5 L 0 10 z');
            arrowPath.setAttribute('fill', '#343a40'); marker.appendChild(arrowPath);
            defs.appendChild(marker); svg.appendChild(defs);

            if (shape === 'octagonal') {
                const createOctagon = (flatToFlat, style) => {
                    const circumRadius = (flatToFlat / 2) / Math.cos(Math.PI / 8);
                    const points = [];
                    for (let i = 0; i < 8; i++) {
                        const angle = (Math.PI / 8) + i * (Math.PI / 4);
                        const x = cx + (circumRadius * scale) * Math.cos(angle);
                        const y = cy - (circumRadius * scale) * Math.sin(angle);
                        points.push(`${x},${y}`);
                    }
                    const polygon = document.createElementNS(svgNS, 'polygon');
                    polygon.setAttribute('points', points.join(' '));
                    for (const key in style) polygon.setAttribute(key, style[key]);
                    return polygon;
                };
                const polyStyle = { stroke: '#343a40', 'stroke-width': '1', fill: 'none' };
                svg.appendChild(createOctagon(outerDia, polyStyle));
                svg.appendChild(createOctagon(innerDia, polyStyle));
            } else {
                const createCircle = (diameter, style) => {
                    const circle = document.createElementNS(svgNS, 'circle');
                    circle.setAttribute('cx', cx); circle.setAttribute('cy', cy);
                    circle.setAttribute('r', (diameter / 2) * scale);
                    for (const key in style) circle.setAttribute(key, style[key]);
                    return circle;
                };
                const circleStyle = { stroke: '#343a40', 'stroke-width': '1', fill: 'none' };
                svg.appendChild(createCircle(outerDia, circleStyle));
                svg.appendChild(createCircle(innerDia, circleStyle));
            }
            
            if (collarSize > outerDia) {
                const collarRadius = (collarSize / 2) * scale;
                const collarCircle = document.createElementNS(svgNS, 'circle');
                collarCircle.setAttribute('cx', cx); collarCircle.setAttribute('cy', cy);
                collarCircle.setAttribute('r', collarRadius);
                collarCircle.setAttribute('stroke', 'black'); collarCircle.setAttribute('stroke-width', '3');
                collarCircle.setAttribute('fill', 'none'); svg.appendChild(collarCircle);
            }

            const createElem = (type, attrs) => {
                const el = document.createElementNS(svgNS, type);
                for (const key in attrs) el.setAttribute(key, attrs[key]);
                return el;
            };

            const outerRadiusScaled = (outerDia / 2) * scale, innerRadiusScaled = (innerDia / 2) * scale;
            const od_dim_x = cx + outerRadiusScaled + 40;
            svg.appendChild(createElem('line', { x1: cx, y1: cy - outerRadiusScaled, x2: od_dim_x, y2: cy - outerRadiusScaled, class: 'dimension-line', 'stroke-dasharray': '2,2' }));
            svg.appendChild(createElem('line', { x1: cx, y1: cy + outerRadiusScaled, x2: od_dim_x, y2: cy + outerRadiusScaled, class: 'dimension-line', 'stroke-dasharray': '2,2' }));
            svg.appendChild(createElem('line', { x1: od_dim_x, y1: cy - outerRadiusScaled, x2: od_dim_x, y2: cy + outerRadiusScaled, class: 'dimension-line', 'marker-start': 'url(#arrow)', 'marker-end': 'url(#arrow)' }));
            const odTextX = od_dim_x + 12;
            const odText = createElem('text', { x: odTextX, y: cy, class: 'dimension-text', 'text-anchor': 'middle', transform: `rotate(-90, ${odTextX}, ${cy})` });
            odText.textContent = `${outerDia.toFixed(1)}`; svg.appendChild(odText);

            const id_dim_x = cx + innerRadiusScaled + 15;
            svg.appendChild(createElem('line', { x1: cx, y1: cy - innerRadiusScaled, x2: id_dim_x, y2: cy - innerRadiusScaled, class: 'dimension-line', 'stroke-dasharray': '2,2' }));
            svg.appendChild(createElem('line', { x1: cx, y1: cy + innerRadiusScaled, x2: id_dim_x, y2: cy + innerRadiusScaled, class: 'dimension-line', 'stroke-dasharray': '2,2' }));
            svg.appendChild(createElem('line', { x1: id_dim_x, y1: cy - innerRadiusScaled, x2: id_dim_x, y2: cy + innerRadiusScaled, class: 'dimension-line', 'marker-start': 'url(#arrow)', 'marker-end': 'url(#arrow)' }));
            const idTextX = id_dim_x + 12;
            const idText = createElem('text', { x: idTextX, y: cy, class: 'dimension-text', 'text-anchor': 'middle', transform: `rotate(-90, ${idTextX}, ${cy})` });
            idText.textContent = `${innerDia.toFixed(1)}`; svg.appendChild(idText);

            const angle = 135 * Math.PI / 180;
            const arrowTipX = cx + outerRadiusScaled * Math.cos(angle), arrowTipY = cy - outerRadiusScaled * Math.sin(angle);
            const leaderElbowX = cx - outerRadiusScaled - 20, leaderElbowY = cy - outerRadiusScaled - 20;
            svg.appendChild(createElem('line', { x1: leaderElbowX, y1: leaderElbowY, x2: arrowTipX, y2: arrowTipY, class: 'dimension-line', 'marker-end': 'url(#arrow)' }));
            const textLineStartX = leaderElbowX - 30;
            svg.appendChild(createElem('line', { x1: leaderElbowX, y1: leaderElbowY, x2: textLineStartX, y2: leaderElbowY, class: 'dimension-line' }));
            const wtText = createElem('text', { x: textLineStartX + (leaderElbowX - textLineStartX) / 2, y: leaderElbowY - 5, class: 'dimension-text' });
            wtText.textContent = `${wallThick.toFixed(1)}`; svg.appendChild(wtText);
            container.appendChild(svg);
        }
        
        // --- CALCULATION AND LOGIC FUNCTIONS ---

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            userSelectedAxleIndex = null; 
            const reader = new FileReader();
            reader.onerror = () => alert('An error occurred while reading the file.');
            
            reader.onload = async function(e) { 
                try {
                    const fileData = e.target.result;
                    const workbook = XLSX.read(new Uint8Array(fileData), { type: 'array' });
                    
                    const required = {
                        'Lath': ['Name', 'Kgs/ m2', 'Thickness', 'Compressed lath height', 'uncompressed lath height', 'Friction %', 'Max Width', 'Lath image', 'Moment of inertia iy', 'Allowable Bending Stress (MPa)', 'vision percentage'],
                        'Bottom lath': ['Bottom lath name', 'BLath weight / m length', 'BLath height'],
                        'Axles': ['Name', 'Diameter', 'Wall Thickness', 'Material grade', "Density (kg/m3)", 'Shape'],
                        'Motors': ['Name', 'Torque (Nm) min', 'Torque (Nm) max', 'RPM', 'Mounting type', 'Wattage'],
                        'SafetyB': ['Name', 'Max Safety Torque (Nm)', 'Driveshaft diameter mm', 'Stop distance', 'SB image'],
                        'Endplate': ['Name', 'Size', 'Material', 'Fixing holes'],
                        'Wicket doors': ['Name', 'Height', 'Width'],
                        'Endlock': ['Description', 'Weight in grams']
                    };

                    for (const sheetName in required) {
                        if (!workbook.Sheets[sheetName]) {
                            if (sheetName === 'Wicket doors' || sheetName === 'Endlock') {
                                console.warn(`Optional sheet "${sheetName}" not found.`);
                                if(sheetName === 'Wicket doors') wicketData = [];
                                if(sheetName === 'Endlock') endlockData = [];
                                continue;
                            }
                            const coreRequired = {
                                'Lath': ['Name', 'Kgs/ m2', 'Thickness', 'Compressed lath height', 'uncompressed lath height', 'Moment of inertia iy', 'Allowable Bending Stress (MPa)'],
                                'Bottom lath': ['Bottom lath name', 'BLath weight / m length'], 'Axles': ['Name', 'Diameter', 'Wall Thickness'],
                                'Motors': ['Name', 'Torque (Nm) max', 'Mounting type'], 'SafetyB': ['Name', 'Max Safety Torque (Nm)'],
                                'Endplate': ['Name', 'Size', 'Material'], 'Wicket doors': ['Name', 'Height', 'Width'],
                                'Endlock': ['Description', 'Weight in grams']
                            };
                            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                            if (sheetData.length > 0) {
                                const headerRow = sheetData[0].map(h => String(h).toLowerCase().trim());
                                for (const requiredCol of coreRequired[sheetName]) {
                                    if (!headerRow.includes(requiredCol.toLowerCase().trim())) {
                                        throw new Error(`Required column "${requiredCol}" not found in sheet "${sheetName}". Please check spelling.`);
                                    }
                                }
                            } else {
                               throw new Error(`Required sheet "${sheetName}" not found or is empty in the Excel file.`);
                            }
                        }
                        
                        const objectData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                        switch (sheetName) {
                            case 'Lath': lathData = objectData; break;
                            case 'Bottom lath': bottomLathData = objectData; break;
                            case 'Axles': axleData = objectData; break;
                            case 'Motors': motorData = objectData; break;
                            case 'SafetyB': safetyBrakeData = objectData; break;
                            case 'Endplate': endplateData = objectData; break;
                            case 'Wicket doors': wicketData = objectData; break;
                            case 'Endlock': endlockData = objectData; break;
                        }
                    }

                    lathImageMap.clear(); safetyBrakeImageMap.clear();
                    const exceljsWorkbook = new ExcelJS.Workbook();
                    await exceljsWorkbook.xlsx.load(fileData);

                    const lathSheet = exceljsWorkbook.getWorksheet('Lath');
                    if (lathSheet) await extractImagesFromSheet(exceljsWorkbook, lathSheet, 'name', 'lath image', lathImageMap);
                    
                    const safetyBrakeSheet = exceljsWorkbook.getWorksheet('SafetyB');
                    if (safetyBrakeSheet) await extractImagesFromSheet(exceljsWorkbook, safetyBrakeSheet, 'name', 'sb image', safetyBrakeImageMap);
                    
                    populateDropdown(dom.lathType, lathData, 'Name');
                    const visionSelect = dom.visionLathType;
                    visionSelect.innerHTML = `<option value="">-- Select a vision lath --</option>`;
                    lathData.forEach((item, index) => {
                        const visionKey = Object.keys(item).find(k => k.toLowerCase().trim() === 'vision percentage');
                        const visionValue = visionKey ? (parseFloat(item[visionKey]) || 0) : 0;
                        if (visionValue > 0) {
                            const option = document.createElement('option');
                            option.value = index;
                            const nameKey = Object.keys(item).find(k => k.toLowerCase().trim() === 'name');
                            option.textContent = item[nameKey];
                            visionSelect.appendChild(option);
                        }
                    });
                    populateDropdown(dom.bottomLathType, bottomLathData, 'Bottom lath name');
                    populateDropdown(dom.endlockType, endlockData, 'Description');
                    populateMotorMountingTypes();
                    populateDropdown(dom.wicketDoorSelector, wicketData, 'Name');
                    ['lathType', 'bottomLathType', 'visionLathType', 'motorMountingType', 'safetyBrakeSelector', 'axleType', 'endplateSelector', 'wicketDoorSelector', 'endlockType'].forEach(id => {
                        if(dom[id]) dom[id].disabled = false;
                    });
                    updateSelectedWicketInfo(); 

                    dom['import-status'].textContent = 'Successfully imported all data sheets.';
                    dom['import-status'].style.color = 'green';
                    updateAllCalculations();
                } catch (error) {
                    alert(`Error Reading File: ${error.message}`);
                    lathData = []; axleData = []; motorData = []; bottomLathData = []; safetyBrakeData = []; endplateData = []; wicketData = []; endlockData = [];
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function updateAllCalculations() {
            if (lathData.length === 0) return;

            const selectedLathIndex = dom.lathType.value;
            const lathImageContainer = document.getElementById('lath-image-container');
            const lathImageDisplay = document.getElementById('lathImageDisplay');
            if (selectedLathIndex && lathData[selectedLathIndex]) {
                const selectedLathName = lathData[selectedLathIndex]['Name'];
                if (lathImageMap.has(selectedLathName)) {
                    lathImageDisplay.src = lathImageMap.get(selectedLathName);
                    lathImageContainer.style.display = 'block';
                } else {
                    lathImageContainer.style.display = 'none';
                }
            } else {
                lathImageContainer.style.display = 'none';
            }

            const visionLathImageContainer = document.getElementById('vision-lath-image-container');
            const visionLathImageDisplay = document.getElementById('visionLathImageDisplay');
            if (dom.addVision.checked) {
                const selectedVisionLathIndex = dom.visionLathType.value;
                 if (selectedVisionLathIndex && lathData[selectedVisionLathIndex]) {
                    const selectedVisionLathName = lathData[selectedVisionLathIndex]['Name'];
                    if (lathImageMap.has(selectedVisionLathName)) {
                        visionLathImageDisplay.src = lathImageMap.get(selectedVisionLathName);
                        visionLathImageContainer.style.display = 'block';
                    } else { visionLathImageContainer.style.display = 'none'; }
                } else { visionLathImageContainer.style.display = 'none'; }
            } else { visionLathImageContainer.style.display = 'none'; }

            const selectedLath = lathData[dom.lathType.value];
            const widthWarningDiv = dom['width-warning'];
            if (selectedLath) {
                const maxWidthKey = Object.keys(selectedLath).find(k => k.toLowerCase().trim() === 'max width');
                const maxWidth = maxWidthKey ? parseFloat(selectedLath[maxWidthKey]) : 0;
                const currentWidth = parseFloat(dom.width.value) || 0;
                if (maxWidth > 0 && currentWidth > maxWidth) {
                    widthWarningDiv.textContent = `Warning: The entered width exceeds the maximum of ${maxWidth} mm for this lath type.`;
                    widthWarningDiv.style.display = 'block';
                } else {
                    widthWarningDiv.style.display = 'none';
                }
            } else {
                widthWarningDiv.style.display = 'none';
            }
            
            if (axleData.length === 0 || safetyBrakeData.length === 0) {
                drawDeflectionGraphic(0, 0); drawAxleCrossSection(null);
                calculateSafetyBrakeForce(); drawShutterGraphic(); 
                return;
            };
            
            const selectedBottomLath = bottomLathData[dom.bottomLathType.value];
            
            const estCurtainProps = calculateCurtainProperties(selectedLath, selectedBottomLath, null);
            const { bestAxle } = findAndSetBestAxle(estCurtainProps.totalWeight);

            const finalCurtainProps = calculateCurtainProperties(selectedLath, selectedBottomLath, bestAxle);
            const { totalWeight, travelHeight, fullCurtainLength, visionData } = finalCurtainProps;
            visionCalcs = visionData;

            calculateWindResistance();
            calculateEndplateRecommendation(); 

            const { deflection, totalLength } = findAndSetBestAxle(totalWeight);

            drawDeflectionGraphic(totalLength, deflection);
            calculateMotorRecommendation(totalWeight, selectedLath, bestAxle, travelHeight);
            calculateSafetyBrakeForce(totalWeight, selectedLath, bestAxle, travelHeight, fullCurtainLength);
            
            const selectedEndplateIndex = dom.endplateSelector.value;
            const selectedEndplate = (selectedEndplateIndex !== "" && currentFilteredEndplates[selectedEndplateIndex]) 
                ? currentFilteredEndplates[selectedEndplateIndex] : null;

            drawShutterGraphic(
                parseFloat(dom.width.value), parseFloat(dom.additionalLength.value),
                parseInt(dom['lath-count'].textContent), selectedLath, selectedBottomLath,
                bestAxle, selectedEndplate, visionCalcs
            );
            updateWicketCalculationsAndGraphic();
        }
        
        // *** SCRIPT REORDER END ***

        // --- EVENT LISTENERS AND INITIALIZATION ---

        ['width', 'additionalLength', 'height', 'friction', 'motorMountingType', 'bottomLathType', 'lathType', 'matSteel', 'matAluminium',
         'visionLathType', 'visionStartHeight', 'visionPanelHeight', 'powderCoated', 'includeDeflectionInSizing', 'collarSize', 'endlockType'
        ].forEach(id => {
            if (dom[id]) dom[id].addEventListener('input', () => {
                userSelectedAxleIndex = null; 
                if (id === 'lathType' && lathData.length > 0) {
                    const selectedLath = lathData[dom.lathType.value];
                    if (selectedLath && selectedLath['Friction %'] !== undefined) {
                        dom.friction.value = selectedLath['Friction %'];
                    }
                }
                updateAllCalculations();
            });
        });

        dom.addVision.addEventListener('change', () => {
            dom['vision-slat-options'].style.display = dom.addVision.checked ? 'block' : 'none';
            updateAllCalculations();
        });

        dom.motorSelector.addEventListener('change', updateSelectedMotorInfo);
        dom.endplateSelector.addEventListener('change', updateSelectedEndplateInfo);
        tabButtons.forEach(button => button.addEventListener('click', () => switchTab(button.dataset.tab)));
        dom.safetyBrakeSelector.addEventListener('input', updateSelectedSafetyBrakeInfo);
        dom.axleType.addEventListener('input', handleAxleOverride);
        dom.wicketDoorSelector.addEventListener('input', updateSelectedWicketInfo);
        dom.printButton.addEventListener('click', () => window.print());

        function handleAxleOverride() {
            if (dom.axleType.value !== "") {
                userSelectedAxleIndex = dom.axleType.value; 
                updateAllCalculations(); 
            }
        }
        
        // Initial call to perform calculations on page load (if data loads automatically)
        // updateAllCalculations();
    </script>

    <!-- Auto-load script -->
    <script>
        window.addEventListener('load', () => {
            const excelFileUrl = 'https://raw.githubusercontent.com/rob-hyrons/SWS_logic_calculator/main/Calculations%20gfa.xlsx';
            const statusDiv = document.getElementById('import-status');
            statusDiv.textContent = 'Loading data from repository...';
            statusDiv.style.color = '#555';

            fetch(excelFileUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    return response.arrayBuffer();
                })
                .then(fileData => {
                    userSelectedAxleIndex = null; 
                    (async () => {
                        try {
                            const workbook = XLSX.read(new Uint8Array(fileData), { type: 'array' });
                            const required = {
                                'Lath': ['Name', 'Kgs/ m2', 'Thickness', 'Compressed lath height', 'uncompressed lath height'],
                                'Bottom lath': ['Bottom lath name', 'BLath weight / m length'],
                                'Axles': ['Name', 'Diameter', 'Wall Thickness'], 'Motors': ['Name', 'Torque (Nm) max', 'Mounting type'],
                                'SafetyB': ['Name', 'Max Safety Torque (Nm)'], 'Endplate': ['Name', 'Size', 'Material'],
                                'Wicket doors': ['Name', 'Height', 'Width'], 'Endlock': ['Description', 'Weight in grams']
                            };

                            for (const sheetName in required) {
                                if (!workbook.Sheets[sheetName]) {
                                    if (sheetName === 'Wicket doors' || sheetName === 'Endlock') {
                                        console.warn(`Optional sheet "${sheetName}" not found.`);
                                        if (sheetName === 'Wicket doors') wicketData = [];
                                        if (sheetName === 'Endlock') endlockData = [];
                                        continue;
                                    }
                                    throw new Error(`Required sheet "${sheetName}" not found in the Excel file.`);
                                }
                                const objectData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                                switch (sheetName) {
                                    case 'Lath': lathData = objectData; break;
                                    case 'Bottom lath': bottomLathData = objectData; break;
                                    case 'Axles': axleData = objectData; break;
                                    case 'Motors': motorData = objectData; break;
                                    case 'SafetyB': safetyBrakeData = objectData; break;
                                    case 'Endplate': endplateData = objectData; break;
                                    case 'Wicket doors': wicketData = objectData; break;
                                    case 'Endlock': endlockData = objectData; break;
                                }
                            }

                            lathImageMap.clear(); safetyBrakeImageMap.clear();
                            const exceljsWorkbook = new ExcelJS.Workbook();
                            await exceljsWorkbook.xlsx.load(fileData);
                            const lathSheet = exceljsWorkbook.getWorksheet('Lath');
                            if (lathSheet) await extractImagesFromSheet(exceljsWorkbook, lathSheet, 'name', 'lath image', lathImageMap);
                            const safetyBrakeSheet = exceljsWorkbook.getWorksheet('SafetyB');
                            if (safetyBrakeSheet) await extractImagesFromSheet(exceljsWorkbook, safetyBrakeSheet, 'name', 'sb image', safetyBrakeImageMap);
                            
                            populateDropdown(dom.lathType, lathData, 'Name');
                            const visionSelect = dom.visionLathType;
                            visionSelect.innerHTML = `<option value="">-- Select a vision lath --</option>`;
                            lathData.forEach((item, index) => {
                                const visionKey = Object.keys(item).find(k => k.toLowerCase().trim() === 'vision percentage');
                                const visionValue = visionKey ? (parseFloat(item[visionKey]) || 0) : 0;
                                if (visionValue > 0) {
                                    const option = document.createElement('option');
                                    option.value = index;
                                    const nameKey = Object.keys(item).find(k => k.toLowerCase().trim() === 'name');
                                    option.textContent = item[nameKey];
                                    visionSelect.appendChild(option);
                                }
                            });
                            populateDropdown(dom.bottomLathType, bottomLathData, 'Bottom lath name');
                            populateDropdown(dom.endlockType, endlockData, 'Description');
                            populateMotorMountingTypes();
                            populateDropdown(dom.wicketDoorSelector, wicketData, 'Name');

                            ['lathType', 'bottomLathType', 'visionLathType', 'motorMountingType', 'safetyBrakeSelector', 'axleType', 'endplateSelector', 'wicketDoorSelector', 'endlockType'].forEach(id => {
                                if(dom[id]) dom[id].disabled = false;
                            });

                            updateSelectedWicketInfo(); 
                            statusDiv.textContent = 'Successfully loaded data from repository.';
                            statusDiv.style.color = 'green';
                            updateAllCalculations();

                        } catch (error) {
                            statusDiv.textContent = `Error processing Excel file: ${error.message}`;
                            statusDiv.style.color = 'red';
                            console.error(error);
                            alert(`Error Reading File: ${error.message}`);
                            lathData = []; axleData = []; motorData = []; bottomLathData = []; safetyBrakeData = []; endplateData = []; wicketData = []; endlockData = [];
                        }
                    })();
                })
                .catch(error => {
                    statusDiv.textContent = 'Failed to fetch the Excel file from the repository.';
                    statusDiv.style.color = 'red';
                    console.error('There has been a problem with the fetch operation:', error);
                });
        });
    </script>
</body>
</html>
