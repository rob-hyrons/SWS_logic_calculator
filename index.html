<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Shutter Motor Calculator</title>
    <!-- xlsx.js for data reading (existing) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- ExcelJS for image extraction (new) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <!-- Papa Parse for CSV importing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f9; color: #333; display: flex; justify-content: center;
            align-items: flex-start; min-height: 100vh; margin: 0; padding: 2em;
        }
        #logo-image {
            position: absolute;
            top: 2em;
            right: 2em;
            width: 10vw;
            max-width: 150px;
            height: auto;
            z-index: 10;
        }
        .container {
            background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1000px; 
            display: flex; flex-direction: row;
            align-items: stretch;
        }
        .content-area {
            padding: 2em;
            flex-grow: 1;
            border-left: 1px solid #dee2e6;
        }
        h1 { color: #1a1a1a; text-align: center; margin-bottom: 1em; }
        .form-group { margin-bottom: 1.5em; }
        .form-row {
            display: flex;
            gap: 1.5em; /* Spacing between columns */
        }
        .form-col {
            flex: 1; /* Each column takes up equal space */
        }
        label { display: block; margin-bottom: 0.5em; font-weight: 600; }
        input[type="number"], input[type="file"], select, input[type="checkbox"] {
            width: 100%; padding: 0.8em; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        input[type="checkbox"] { width: auto; }
        input[type="file"] { padding: 0.5em; }
        .radio-group label { display: inline-block; margin-right: 15px; font-weight: 500;}
        .radio-group input[type="radio"] { margin-right: 5px; }
        .results {
            margin-top: 1.5em; background-color: #f8f9fa; padding: 1.5em; border-radius: 6px; border-left: 5px solid #007bff;
        }
        .results h3 { margin-top: 0; color: #0056b3; }
        .results h4 { margin-top: 1em; margin-bottom: 0.5em; color: #495057;}
        .results p { font-size: 1.1em; margin: 0.5em 0; line-height: 1.5; }
        .results span { font-weight: bold; color: #1a1a1a; }
        #import-status { margin-top: 0.5em; font-style: italic; color: #555; }
        
        .tabs {
            display: flex;
            flex-direction: column;
            background-color: #f1f3f5;
            flex-shrink: 0;
            width: 55px;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }
        .tab-button {
            height: 120px;
            padding: 0.5em;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #555;
            border-left: 5px solid transparent;
            transition: all 0.2s ease-in-out;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            text-align: center;
        }
        .tab-button:hover {
            filter: brightness(75%);
        }
        .tab-button.active {
            font-weight: 700;
            color: #000;
            border-left-color: #0d6efd;
        }
        /* Tab Colors */
        .tab-button:nth-child(1) { background-color: #e3f2fd; }
        .tab-button:nth-child(2) { background-color: #e8f5e9; }
        .tab-button:nth-child(3) { background-color: #fff3e0; }
        .tab-button:nth-child(4) { background-color: #fce4ec; }
        .tab-button:nth-child(5) { background-color: #ede7f6; }
        .tab-button:nth-child(6) { background-color: #e0f7fa; }
        .tab-button:nth-child(7) { background-color: #e9ecef; } /* Admin Tab Color */

        .tab-button.active:nth-child(1) { background-color: #cce5ff; }
        .tab-button.active:nth-child(2) { background-color: #d1e7dd; }
        .tab-button.active:nth-child(3) { background-color: #ffe5b4; }
        .tab-button.active:nth-child(4) { background-color: #f8d7da; }
        .tab-button.active:nth-child(5) { background-color: #dcd0ff; }
        .tab-button.active:nth-child(6) { background-color: #b2ebf2; }
        .tab-button.active:nth-child(7) { background-color: #ced4da; } /* Admin Tab Active Color */
        
        .tab-pane { display: block; }
        .tab-pane:not(.active) { display: none; }
        .tab-pane.active { display: block; padding-bottom: 2em; }
        .warning-text, p .warning-text, span.warning-text { color: #d93025 !important; font-weight: bold; }
        
        .width-validation-warning {
            color: #d93025;
            font-weight: 500;
            font-size: 0.9em;
            margin-top: 0.5em;
            display: none; /* Hidden by default */
        }

        #recommendation-box {
            display: none; margin-top: 1em; padding: 1em; background-color: #fffbe6;
            border: 1px solid #ffe58f; border-radius: 4px; color: #d46b08; font-weight: bold;
        }
        .graph-container { margin-top: 1.5em; width: 100%; }
        #axle-cross-section-container, 
        #endplate-graphic-container {
            min-width: 450px;
            max-width: 550px;
            margin-left: auto;
            margin-right: auto;
        }
        .calculation-explainer {
            margin-top: 2em;
            padding: 1em;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        .calculation-explainer h4 { margin-top: 0; color: #495057; }
        .calculation-explainer span { font-weight: bold; color: #0056b3; }
        
        /* SVG Styles */
        .beam-path { stroke: #adb5bd; stroke-width: 2; fill: none; }
        .deflected-path { stroke: #007bff; stroke-width: 4; fill: none; transition: d 0.3s ease-out; }
        .deflected-path.warning { stroke: #d93025; }
        .graph-text { font-family: sans-serif; font-size: 12px; fill: #343a40; text-anchor: middle; }
        .axis-line { stroke: #ced4da; stroke-width: 1; }
        .torque-bar { fill: #007bff; transition: all 0.2s ease-out; }
        .torque-bar:hover { fill: #0056b3; }
        .graph-data-label { font-size: 10px; text-anchor: middle; fill: #495057; }
        
        .support-symbol { fill: #868e96; stroke: #495057; stroke-width: 1; }
        .coil-wrap-graphic { fill: none; stroke: #adb5bd; stroke-width: 0.5; }
        
        /* Force Diagram Specific Styles */
        .force-text { font-family: sans-serif; font-size: 11px; text-anchor: middle; }
        .force-text.red { fill: #d93025; font-weight: bold;}
        .force-text.blue { fill: #007bff; font-weight: bold;}
        .dim-text-force-diagram { font-family: sans-serif; font-size: 10px; fill: #343a40; text-anchor: middle;}


        .option-pass {
            color: #1e8e3e; /* Green */
            font-weight: bold;
        }
        .option-fail {
            color: #d93025; /* Red */
        }

        #shutter-graphic-container, #wicket-graphic-container, #width-graphic-container {
            margin-top: 1.5em;
            width: 100%;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .shutter-axle-graphic { fill: #6c757d; stroke: #495057; stroke-width: 0.5; }
        .shutter-lath-graphic { fill: #e9ecef; stroke: #adb5bd; stroke-width: 0.5; }
        .shutter-bottomlath-graphic { fill: #ced4da; stroke: #495057; stroke-width: 0.5; }
        .wicket-door-graphic { fill: #a5d6a7; stroke: #388e3c; stroke-width: 1; }
        .shutter-vision-lath-graphic { fill: #a7d8f0; stroke: #6bafd2; stroke-width: 0.5; }
        .endlock-graphic { fill: #000000; }
        .wind-endlock-graphic { fill: #555555; } /* Dark Grey */
        .endplate-box-graphic {
            fill: rgba(255, 193, 7, 0.2); /* Semi-transparent yellow */
            stroke: #ffc107;
            stroke-width: 1;
            stroke-dasharray: 4, 2;
        }
        
        .axle-centerline-graphic { stroke: #d93025; stroke-width: 1; stroke-dasharray: 4, 2; }
        .dimension-line { stroke: #343a40; stroke-width: 1; }
        .leader-line { stroke: #343a40; stroke-width: 0.5; stroke-dasharray: 2,2; }
        .dimension-text { font-family: sans-serif; font-size: 5px; fill: #343a40; text-anchor: middle; }
        .large-dimension-text { font-family: sans-serif; font-size: 10px; fill: #343a40; text-anchor: middle; }
        .shutter-overlay-text {
            font-family: sans-serif;
            font-size: 10px;
            font-weight: bold;
            fill: #343a40;
            text-anchor: middle;
            pointer-events: none;
        }
        /* New styles for top-down graphic */
        .width-graphic-label { font-family: sans-serif; font-size: 14px; fill: #343a40; text-anchor: middle; }
        .width-graphic-value { font-family: sans-serif; font-size: 10px; fill: #555; text-anchor: middle; }
        .dimension-tick { stroke: #343a40; stroke-width: 1; }

        .print-container {
            display: flex;
            justify-content: flex-end;
            padding: 0;
            margin-bottom: 1em;
        }
        #printButton {
            padding: 0.8em 1.5em;
            font-size: 0.9em;
            font-weight: 600;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color: 0.2s;
        }
        #printButton:hover {
            background-color: #0056b3;
        }

        /* Admin Page Styles */
        .admin-section {
            margin-bottom: 2em;
            padding: 1.5em;
            border: 1px solid #dee2e6;
            border-radius: 6px;
        }
        .admin-section h3 {
            margin-top: 0;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5em;
        }
        .admin-section h4 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            color: #495057;
        }
        .admin-controls, .report-filter-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1em;
            margin-top: 1em;
        }
        .admin-control-item label {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .admin-button-group {
            display: flex;
            gap: 1em;
            margin-bottom: 1.5em;
        }
        .admin-button-group button, #importCsvButton, #generateCsvButton {
            padding: 0.5em 1em;
            font-size: 0.8em;
            font-weight: 500;
            color: #fff;
            background-color: #6c757d;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .admin-button-group button:hover, #importCsvButton:hover, #generateCsvButton:hover {
            background-color: #5a6268;
        }
        #importCsvButton { background-color: #28a745; }
        #importCsvButton:hover { background-color: #218838; }
        #generateCsvButton { background-color: #007bff; font-size: 0.9em; padding: 0.8em 1.2em; }
        #generateCsvButton:hover { background-color: #0056b3; }

        .report-controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1em;
            margin-bottom: 1.5em;
        }
        .report-filter-container {
             max-height: 200px;
             overflow-y: auto;
             padding: 1em;
             border: 1px solid #dee2e6;
             border-radius: 4px;
        }

        /* Axle Shape Toggle Styles */
        .shape-toggle {
            display: flex;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden;
        }
        .shape-toggle input[type="radio"] {
            display: none;
        }
        .shape-toggle label {
            flex: 1;
            text-align: center;
            padding: 0.8em;
            margin: 0;
            cursor: pointer;
            background-color: #f8f9fa;
            color: #495057;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        .shape-toggle input[type="radio"]:checked + label {
            background-color: #007bff;
            color: white;
            font-weight: 600;
        }


        @media print {
            body {
                font-family: Arial, sans-serif; background-color: #fff; padding: 0; margin: 0;
            }
            @page {
                size: A4; margin: 15mm;
            }
            .tabs, .form-group, .print-container, .calculation-explainer, hr, #import-status, #recommendation-box, #admin-content, #logo-image {
                display: none !important;
            }
            .tab-pane {
                display: block !important;
                padding-top: 1em;
            }
            .hide-in-print {
                display: none !important;
            }
            .page-break-before-print {
                page-break-before: always;
            }
            .container {
                 display: block;
                 box-shadow: none; border: none; width: 100%; max-width: 100%; padding: 0;
            }
            .content-area {
                padding: 0;
                border-left: none;
            }
            * { color: #000 !important; }
            h1 {
                font-size: 20pt; text-align: center !important; border: none; margin-bottom: 1.5em;
            }
            h2 {
                font-size: 15pt; border-bottom: 2px solid #ccc; padding-bottom: 4px;
                margin-top: 1.5em; margin-bottom: 1em;
            }
            .tab-pane > h2:first-of-type {
                margin-top: 0;
            }
            .results {
                border: 1px solid #ccc; border-left: none; page-break-inside: avoid;
                margin-top: 1em; padding: 1em;
            }
            .graph-container, #shutter-graphic-container, #wicket-graphic-container, #width-graphic-container {
                width: 100% !important; max-width: 450px;
                margin-left: auto; margin-right: auto; page-break-inside: avoid;
            }
            #lath-image-container, #vision-lath-image-container, #safety-brake-image-container {
                page-break-inside: avoid;
                text-align: center;
                padding: 1em 0;
            }
            #lath-image-container img, #vision-lath-image-container img, #safety-brake-image-container img {
                max-height: 80px;
            }
            svg { width: 100% !important; }
        }

    </style>
</head>
<body>
    <img src="https://raw.githubusercontent.com/rob-hyrons/SWS_logic_calculator/main/swslogo.svg" alt="SWS Logo" id="logo-image">
    <div class="container">
        <div class="tabs">
            <button class="tab-button active" data-tab="inputs-content">Inputs</button>
            <button class="tab-button" data-tab="axle-content">Axle</button>
            <button class="tab-button" data-tab="motor-content">Motor</button>
            <button class="tab-button" data-tab="endplate-content">Endplate</button>
            <button class="tab-button" data-tab="safety-brake-content">Safety Brake</button>
            <button class="tab-button" data-tab="wicket-content">Wicket Door</button>
            <button class="tab-button" data-tab="admin-content">Admin</button>
        </div>
        <div class="content-area">
            <h1>Complete Shutter Calculator</h1>
            
            <div class="print-container">
                <button id="printButton">Print Report to PDF</button>
            </div>

            <div class="tab-content">
                <!-- Inputs Tab -->
                <div id="inputs-content" class="tab-pane active">
                    <h2>Shutter Specification</h2>
                    <div class="form-group" data-admin-label="File Import Status">
                         <div id="import-status">Attempting to load data from repository...</div>
                    </div>
                    <div class="form-row">
                        <div class="form-group form-col" data-admin-label="Input Width">
                            <label for="width">Input Width (mm)</label>
                            <input type="number" id="width" placeholder="e.g., 3000">
                            <div id="width-warning" class="width-validation-warning"></div>
                        </div>
                        <div class="form-group form-col" data-admin-label="Width Type">
                            <label for="widthType">Width Type</label>
                            <select id="widthType">
                                <option value="clearOpening">Clear Opening</option>
                                <option value="curtainWidth" selected>Curtain Width</option>
                                <option value="overall">Overall (Reveal)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group form-col" data-admin-label="Guide Type">
                            <label for="guideType">Guide Type</label>
                            <select id="guideType" disabled>
                                <option value="">-- Waiting for file import --</option>
                            </select>
                        </div>
                        <div class="form-group form-col" data-admin-label="Curtain Height">
                            <label for="height">Curtain Height (Floor to Axle Centre, mm)</label>
                            <input type="number" id="height" placeholder="e.g., 4000">
                        </div>
                    </div>
                     <div class="form-group" data-admin-label="Additional Axle Width">
                        <label for="additionalLength">Additional Axle Width (Total, mm)</label>
                        <input type="number" id="additionalLength" placeholder="e.g., 100" value="100">
                    </div>
                    <div class="form-row">
                        <div class="form-group form-col" data-admin-label="Lath Type">
                            <label for="lathType">Lath Type</label>
                            <select id="lathType" disabled>
                                <option value="">-- Waiting for file import --</option>
                            </select>
                        </div>
                        <div class="form-group form-col" data-admin-label="Endlock Type">
                            <label for="endlockType">Endlock Type</label>
                            <select id="endlockType" disabled>
                                <option value="">-- Waiting for file import --</option>
                            </select>
                        </div>
                    </div>
                     <!-- NEW CUSTOM LATH SECTION -->
                    <div class="form-group" data-admin-label="Custom Lath Option">
                        <label for="useCustomLath" style="display: inline-block; font-weight: 500; cursor: pointer;">
                            <input type="checkbox" id="useCustomLath" style="width: auto; margin-right: 8px; vertical-align: middle;">Use Custom Lath
                        </label>
                    </div>
                    <div id="custom-lath-options" data-admin-label="Custom Lath Weight" style="display: none; padding-left: 20px; border-left: 3px solid #e9ecef; margin-bottom: 1.5em; margin-top: -1em;">
                        <div class="form-group">
                            <label for="customLathWeight">Custom Lath Weight (kg/m²)</label>
                            <input type="number" id="customLathWeight" placeholder="e.g., 9.5">
                            <small style="font-size: 0.8em; color: #555;">Note: Other properties (thickness, height) will be based on the lath selected above.</small>
                        </div>
                        <div class="form-group">
                            <label for="customTorqueWeight">Custom Curtain Weight for Lift (kg)</label>
                            <input type="number" id="customTorqueWeight" placeholder="e.g., 150.5">
                            <small style="font-size: 0.8em; color: #555;">If a value is entered here, it will override the calculated 'Curtain Weight (for Torque)'.</small>
                        </div>
                    </div>
                    <!-- END NEW SECTION -->
                    <div id="lath-image-container" style="margin-top: 1em; margin-bottom: 1.5em; text-align: center; display: none;">
                        <img id="lathImageDisplay" src="" alt="Lath Image" style="max-width: 100%; max-height: 100px; border-radius: 4px; border: 1px solid #ccc;">
                    </div>
                    <div class="form-group" data-admin-label="Powder Coated Option">
                        <label for="powderCoated" style="display: inline-block; font-weight: 500; cursor: pointer;">
                            <input type="checkbox" id="powderCoated" style="width: auto; margin-right: 8px; vertical-align: middle;">Powder Coated (+0.5 kg/m²)
                        </label>
                    </div>
                    <div class="form-group" data-admin-label="Bottom Lath Type">
                        <label for="bottomLathType">Bottom Lath Type</label>
                        <select id="bottomLathType" disabled>
                            <option value="">-- Waiting for file import --</option>
                        </select>
                    </div>
                    
                    <div class="form-group" data-admin-label="Add Vision Slats Option">
                        <label for="addVision" style="display: inline-block; font-weight: 500; cursor: pointer;">
                            <input type="checkbox" id="addVision" style="width: auto; margin-right: 8px; vertical-align: middle;">Add Vision Slats
                        </label>
                    </div>
                    <div id="vision-slat-options" data-admin-label="Vision Slat Details" style="display: none; padding-left: 20px; border-left: 3px solid #e9ecef; margin-bottom: 1.5em; margin-top: -1em;">
                        <div class="form-group">
                            <label for="visionLathType">Vision Lath Type</label>
                            <select id="visionLathType" disabled>
                                <option value="">-- Waiting for file import --</option>
                            </select>
                        </div>
                        <div id="vision-lath-image-container" style="margin-top: 1em; margin-bottom: 1.5em; text-align: center; display: none;">
                            <img id="visionLathImageDisplay" src="" alt="Vision Lath Image" style="max-width: 100%; max-height: 100px; border-radius: 4px; border: 1px solid #ccc;">
                        </div>
                        <div class="form-group">
                            <label for="visionStartHeight">Height to Vision Start (from floor, mm)</label>
                            <input type="number" id="visionStartHeight" placeholder="e.g., 1000">
                            <small style="font-size: 0.8em; color: #555;">This will be adjusted to the nearest lath.</small>
                        </div>
                        <div class="form-group">
                            <label for="visionPanelHeight">Vision Panel Height (mm)</label>
                            <input type="number" id="visionPanelHeight" placeholder="e.g., 500">
                            <small style="font-size: 0.8em; color: #555;">This will be adjusted to the nearest lath.</small>
                        </div>
                    </div>

                    <div class="results">
                        <h3>Shutter Details</h3>
						<p>Curtain Width (Calculated): <span id="calculated-curtain-width">0</span> mm</p>
						<p>Clear Opening (Calculated): <span id="calculated-clear-opening">0</span> mm</p>
						<p>Overall Width (Calculated): <span id="calculated-overall-width">0</span> mm</p>
						<hr>
                        <p>Total Shutter Weight: <span id="weight-kg">0.00</span> kgs</p>
                        <p>Curtain Weight (for Torque): <span id="torque-weight-kg">0.00</span> kgs</p>
                        <p>Total Endlock Weight: <span id="endlock-weight">0.00</span> kgs</p>
                        <p>Total Curtain Area (Material): <span id="curtain-area">0.00</span> m²</p>
						<p>Curtain Area to Lift (Coverage): <span id="lifted-curtain-area">0.00</span> m²</p>
                        <p id="vision-area-m2-para" style="display: none;">Total Vision Area: <span id="vision-area-m2">0.00</span> m²</p>
                        <p id="vision-percentage-para" style="display: none;">Overall Vision Percentage: <span id="vision-percentage">0.00</span> %</p>
                        <p>Total Number of Laths: <span id="lath-count">0</span></p>
                        <p>Laths to Lift: <span id="laths-to-lift">0</span></p>
                        <p>Uncompressed Curtain Height: <span id="curtain-height-extended">0</span> mm</p>
                        <p>Compressed Curtain Height: <span id="curtain-height-compressed">0</span> mm</p>
                        <!-- NEW MOTOR INFO SECTION -->
                        <h4 style="margin-top: 1em; margin-bottom: 0.5em; color: #495057;">Motor Recommendation</h4>
                        <p>Max Required Torque: <span id="max-torque-inputs">0.0</span> Nm</p>
                        <p>Selected Motor: <span id="motor-name-inputs">N/A</span></p>
                        <p id="motor-torque-line-inputs">Motor Torque Range: <span id="motor-torque-inputs">0</span> Nm</p>
                        <!-- END NEW SECTION -->
                    </div>
                    <div id="shutter-graphic-container"></div>
                    <div id="width-graphic-container" class="graph-container"></div>
                </div>

                <!-- Axle Analysis Tab -->
                <div id="axle-content" class="tab-pane">
                    <h2>Axle Deflection Analysis</h2>
                    
                    <div class="form-group" data-admin-label="Axle Shape">
                        <label>Axle Shape</label>
                        <div class="shape-toggle">
                            <input type="radio" id="shapeCircular" name="axleShape" value="circular" checked>
                            <label for="shapeCircular">Circular</label>
                            <input type="radio" id="shapeOctagonal" name="axleShape" value="octagonal">
                            <label for="shapeOctagonal">Octagonal</label>
                        </div>
                    </div>
                    
                    <div class="form-group" data-admin-label="Axle Type Selector">
                        <label for="axleType">Axle Section (Auto-Selected)</label>
                        <select id="axleType" disabled>
                            <option value="">-- Waiting for file import --</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="collar-size-group" data-admin-label="Collar Size" style="display: none;">
                        <label for="collarSize">Collar Size (mm)</label>
                        <input type="number" id="collarSize" placeholder="e.g., 150" value="0">
                    </div>

                    <div id="deflection-graphic-container" class="graph-container" style="height: 150px;"></div>
                    <div id="axle-cross-section-container" class="graph-container" style="height: 250px; margin-top: 2.5em;"></div>
                    <div class="results">
                        <h3>Axle Performance</h3>
                        <p>Total Axle Length: <span id="total-axle-length">0</span> mm</p>
                        <p>Axle Weight: <span id="axle-weight">0.00</span> kgs</p>
                        <p>Total Weight (for Deflection): <span id="total-deflection-weight">0.00</span> kgs</p>
                        <p>Material Grade: <span id="axle-material-grade">N/A</span></p>
                        <p>Moment of Inertia (I): <span id="moment-of-inertia">0.00</span> mm⁴</p>
                        <p>Calculated Deflection: <span id="axle-deflection">0.00</span> mm</p>
                        <p id="ratio-paragraph">Deflection Ratio: <span id="deflection-ratio">N/A</span></p>
                        <p>Safety Factor: <span id="axle-safety-factor">N/A</span></p>
                    </div>
                    <div id="recommendation-box"></div>
                </div>

                <!-- Motor Tab -->
                <div id="motor-content" class="tab-pane">
                    <h2>Motor & Torque Analysis</h2>
                     <div class="form-group" data-admin-label="Motor Manufacturer">
                        <label for="motorManufacturerFilter">Motor Manufacturer</label>
                        <select id="motorManufacturerFilter" disabled>
                            <option value="">-- Waiting for file import --</option>
                        </select>
                    </div>
                     <div class="form-group" data-admin-label="Motor Voltage">
                        <label for="motorVoltageFilter">Motor Voltage</label>
                        <select id="motorVoltageFilter" disabled>
                            <option value="">-- Waiting for file import --</option>
                        </select>
                    </div>
                    <div class="form-group" data-admin-label="Motor Mounting Type">
                        <label for="motorMountingType">Motor Mounting Type</label>
                        <select id="motorMountingType" disabled>
                            <option value="">-- Waiting for file import --</option>
                        </select>
                    </div>
                    <div class="form-group" data-admin-label="Lath Friction Allowance">
                        <label for="friction">Lath Friction Allowance (%)</label>
                        <input type="number" id="friction" value="10" title="Automatically updated from Lath data. Can be overridden.">
                    </div>
                    <div id="torque-graph-container" class="graph-container" style="height: 280px;"></div>
                    <div class="results">
                        <h3>Torque Calculation</h3>
                        <p>Max Required Torque: <span id="max-torque">0.0</span> Nm</p>
                        <p>Total Revolutions: <span id="total-revolutions">0.0</span></p>
                        <hr>
                        <div class="form-group" data-admin-label="Motor Selector">
                            <label for="motorSelector">Select Motor</label>
                            <select id="motorSelector" disabled>
                                <option>-- First select a mounting type --</option>
                            </select>
                        </div>
                        <h3>Selected Motor Details</h3>
                        <p>Motor Name: <span id="motor-name">N/A</span></p>
                        <p id="motor-torque-line">Motor Torque Range: <span id="motor-torque">0</span> Nm</p>
                        <p>Motor Speed: <span id="motor-rpm">0</span> RPM</p>
                        <p>Opening Time: <span id="opening-time">0</span> seconds</p>
                        <p>Power Consumed per Cycle: <span id="power-consumed">0.0000</span> kWh</p>
                    </div>
                </div>
                
                <div id="endplate-content" class="tab-pane page-break-before-print">
                    <h2>Endplate Selection</h2>
                     <div class="form-group" data-admin-label="Endplate Material">
                        <label>Endplate Material</label>
                        <div class="radio-group">
                            <input type="radio" id="matSteel" name="material" value="Steel" checked>
                            <label for="matSteel">Steel</label>
                            <input type="radio" id="matAluminium" name="material" value="Aluminium">
                            <label for="matAluminium">Aluminium</label>
                        </div>
                    </div>
                    <div class="form-group" data-admin-label="Include Deflection in Sizing">
                        <label for="includeDeflectionInSizing" style="display: inline-block; font-weight: 500; cursor: pointer;">
                            <input type="checkbox" id="includeDeflectionInSizing" style="width: auto; margin-right: 8px; vertical-align: middle;">Include Axle Deflection in Coil Sizing
                        </label>
                    </div>
                    <div class="form-group" data-admin-label="Endplate Selector">
                        <label for="endplateSelector">Select Endplate (Auto-Selected)</label>
                        <select id="endplateSelector" disabled>
                            <option value="">-- Waiting for file import --</option>
                        </select>
                    </div>
                    <div class="results" style="border-left-color: #ffc107;">
                        <h3 style="color: #c79100;">Sizing Details</h3>
                        <p>Maximum Coil Diameter: <span id="max-coil-diameter">0.0</span> mm</p>
                        <p id="effective-coil-para" style="display: none;">Effective Sizing Diameter (inc. deflection): <span id="effective-coil-diameter">0.0</span> mm</p>
                        <hr>
                        <h3>Selected Endplate</h3>
                        <p>Name: <span id="endplate-name">N/A</span></p>
                        <p>Size: <span id="endplate-size">0</span> mm</p>
                        <p>Material: <span id="endplate-material">N/A</span></p>
                        <hr>
                        <h4>Curtain Height Limits by Endplate</h4>
                        <p>For Next Size Down (<span id="prev-endplate-name">N/A</span>): <span id="prev-endplate-height">N/A</span> mm</p>
                        <p>For Next Size Up (<span id="next-endplate-name">N/A</span>): <span id="next-endplate-height">N/A</span> mm</p>
                    </div>
                    <div id="endplate-graphic-container" class="graph-container"></div>
                    <div class="results page-break-before-print" style="border-left-color: #6f42c1; margin-top: 2em;">
                        <h3 style="color: #5a32a3;">Fixing Forces Analysis (Per Endplate, inc. 20% Safety Factor)</h3>
                        <p>Total Downward Shear Force: <span id="endplate-downward-force">0</span> N</p>
                        <p>Resultant Pull-out Force (on top fixing): <span id="endplate-pullout-force">0</span> N</p>
                    </div>
                    <div id="endplate-force-diagram-container" class="graph-container" style="height: 250px; margin-top: 1.5em;"></div>
                </div>

                <!-- Safety Brake Tab -->
                <div id="safety-brake-content" class="tab-pane">
                    <h2>Safety Brake Force Analysis</h2>
                    
                    <div class="form-group" data-admin-label="Safety Brake Selector">
                        <label for="safetyBrakeSelector">Available Safety Brakes (Auto-Selected)</label>
                        <select id="safetyBrakeSelector" disabled>
                            <option value="">-- Waiting for file import --</option>
                        </select>
                    </div>
                    
                    <div id="safety-brake-image-container" style="margin-top: 1em; margin-bottom: 1.5em; text-align: center; display: none;">
                        <img id="safetyBrakeImageDisplay" src="" alt="Safety Brake Image" style="max-width: 100%; max-height: 100px; border-radius: 4px; border: 1px solid #ccc;">
                    </div>

                    <div class="results" style="border-left-color: #d93025;">
                        <h3 style="color: #d93025;">Worst-Case Impact</h3>
                        <p>Selected Safety Brake: <span id="safety-brake-name">N/A</span></p>
                        <p>Brake Max Torque Capacity: <span id="safety-brake-capacity">N/A</span> Nm</p>
                        <p>Driveshaft Diameter: <span id="safety-brake-driveshaft">N/A</span> mm</p>
                        <p>Worst-Case Activation Height (from floor): <span id="sb-activation-height">0.00</span> m</p>
                        <p>Impact Torque on Axle (inc. 20% factor): <span id="safety-brake-torque">0.00</span> Nm</p>
                        <p>Linear Impact Force: <span id="safety-brake-force-kn">0.00</span> kN</p>
                        <p>Equivalent Linear Force: <span id="safety-brake-force-kg">0.00</span> kgf</p>
                    </div>

                    <div class="calculation-explainer">
                        <h4>Calculation Explained</h4>
                        This calculates the shock load if the shutter free-falls from a worst-case height of <strong>1000mm</strong> from the floor. The fall distance before brake engagement is assumed to be <strong>1/8th of the coil's circumference</strong> at that height. A <strong>20% safety factor</strong> is applied to the calculated torque before selecting a brake.
                        <br><br>
                        <strong>Principle:</strong> Potential Energy (from fall) = Work Done (by brake)
                        <br>
                        <code>Force = (Mass × g × Fall Distance) / Stop Distance</code>
                        <br>
                        <code>Torque = Force × Axle Radius</code>
                        <br><br>
                        <strong>Values Used:</strong>
                        <ul>
                            <li>Mass at worst-case height: <span id="sb-mass">0.00</span> kg</li>
                            <li>Fall Distance: <span id="sb-fall-dist">0.000</span> m</li>
                            <li>Gravity (g): <span>9.81</span> m/s²</li>
                            <li>Stop Distance: <span id="sb-stop-dist">0.010</span> m</li>
                        </ul>
                        <span id="sb-activation-height-explainer" style="display: none;"></span>
                    </div>
                </div>
                
                <div id="wicket-content" class="tab-pane">
                    <h2>Wicket Door Selection</h2>
                    <div class="form-group" data-admin-label="Wicket Door Selector">
                        <label for="wicketDoorSelector">Available Wicket Doors</label>
                        <select id="wicketDoorSelector" disabled>
                            <option value="">-- Waiting for file import --</option>
                        </select>
                    </div>
                    <div class="results" style="border-left-color: #00bcd4;">
                        <h3 style="color: #00838f;">Selected Wicket Door</h3>
                        <p>Name: <span id="wicket-door-name">N/A</span></p>
                        <p>Height: <span id="wicket-door-height">0</span> mm</p>
                        <p>Width: <span id="wicket-door-width">0</span> mm</p>
                        <hr>
                        <p>Laths Level with Wicket Door: <span id="laths-at-wicket">0</span></p>
                        <p>Height to Top of Wicket Laths: <span id="wicket-lath-height">0</span> mm</p>
                        <h3 style="margin-top: 1.5em;">Adjusted Motor Torque</h3>
                        <p>Max Required Torque (with Wicket): <span id="wicket-max-torque">0.0</span> Nm</p>
                    </div>
                    <div id="wicket-graphic-container"></div>
                    <div id="wicket-torque-graph-container" class="graph-container" style="height: 280px;"></div>
                </div>

                <!-- Admin Tab -->
                <div id="admin-content" class="tab-pane">
                    <h2>Admin Controls</h2>
                    
                    <div class="admin-section">
                        <h3>Import from CSV</h3>
                        <div class="form-group" style="display: flex; align-items: center; gap: 1em;">
                            <input type="file" id="csvFileInput" accept=".csv" style="flex-grow: 1;">
                            <button id="importCsvButton">Import</button>
                        </div>
                        <div id="import-status-admin" style="font-style: italic; color: #555;"></div>
                    </div>

                    <div class="admin-section">
                        <h3>Tab Visibility</h3>
                        <div class="admin-button-group">
                            <button id="tabsSelectAll">Select All</button>
                            <button id="tabsDeselectAll">Deselect All</button>
                        </div>
                        <div id="tab-controls-container" class="admin-controls">
                            <!-- Tab controls will be generated here by JavaScript -->
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>Input Option Visibility</h3>
                         <div class="admin-button-group">
                            <button id="inputsSelectAll">Select All</button>
                            <button id="inputsDeselectAll">Deselect All</button>
                        </div>
                        <div id="input-controls-container" class="admin-controls">
                            <!-- Input controls will be generated here by JavaScript -->
                        </div>
                    </div>

                    <!-- =================================================================== -->
                    <!-- START: NEW SECTION FOR CSV REPORT GENERATION                        -->
                    <!-- =================================================================== -->
                    <div id="csv-report-section" class="admin-section">
                        <h3>Generate Sizing Report</h3>
                        <p>Configure the report parameters below. This process can take several minutes and may slow down your browser depending on the size of the range selected.</p>
                        
                        <h4>1. Define Size Range (mm)</h4>
                        <div class="report-controls-grid">
                            <div class="form-group">
                                <label for="reportMinWidth">Min Width</label>
                                <input type="number" id="reportMinWidth" value="1000">
                            </div>
                            <div class="form-group">
                                <label for="reportMaxWidth">Max Width</label>
                                <input type="number" id="reportMaxWidth" value="8000">
                            </div>
                             <div class="form-group">
                                <label for="reportInterval">Interval</label>
                                <input type="number" id="reportInterval" value="500">
                            </div>
                            <div class="form-group">
                                <label for="reportMinHeight">Min Height</label>
                                <input type="number" id="reportMinHeight" value="1000">
                            </div>
                            <div class="form-group">
                                <label for="reportMaxHeight">Max Height</label>
                                <input type="number" id="reportMaxHeight" value="6000">
                            </div>
                            <div class="form-group">
                                <label for="axleFixity">Axle Fixity Factor (%)</label>
                                <input type="number" id="axleFixity" value="0" min="0" max="100" title="0% = Simply Supported (Standard/Worst Case), 100% = Fully Fixed Ends (Best Case).">
                                <small style="color: #666;">0% = Simply Supported (Standard), 100% = Fixed Ends.</small>
                            </div>
                        </div>

                        <h4>2. Select Shutter Configuration</h4>
                        <div class="form-row">
                            <div class="form-group form-col">
                                <label for="reportLathType">Lath Type</label>
                                <select id="reportLathType">
                                    <option value="">-- Loading... --</option>
                                </select>
                            </div>
                            <div class="form-group form-col">
                                <label for="reportEndlockType">Endlock Type</label>
                                <select id="reportEndlockType">
                                    <option value="">-- Loading... --</option>
                                </select>
                            </div>
                            <div class="form-group form-col">
                                <label for="reportBottomLathType">Bottom Lath Type</label>
                                <select id="reportBottomLathType">
                                    <option value="">-- Loading... --</option>
                                </select>
                            </div>
                        </div>

                        <h4>3. Select Motor Manufacturers to Include</h4>
                        <div class="admin-button-group">
                            <button id="reportMotorSelectAll">Select All</button>
                            <button id="reportMotorDeselectAll">Deselect All</button>
                        </div>
                        <div id="report-motor-filter-container" class="report-filter-container">
                            <p>Loading motor data...</p>
                        </div>
                        
                        <!-- NEW FILTERS FOR VOLTAGE AND MOUNTING TYPE -->
                        <h4>4. Select Motor Voltages to Include</h4>
                        <div class="admin-button-group">
                            <button id="reportVoltageSelectAll">Select All</button>
                            <button id="reportVoltageDeselectAll">Deselect All</button>
                        </div>
                        <div id="report-motor-voltage-filter-container" class="report-filter-container">
                            <p>Loading motor data...</p>
                        </div>

                        <h4>5. Select Motor Mounting Types to Include</h4>
                        <div class="admin-button-group">
                            <button id="reportMountingSelectAll">Select All</button>
                            <button id="reportMountingDeselectAll">Deselect All</button>
                        </div>
                        <div id="report-motor-mounting-filter-container" class="report-filter-container">
                            <p>Loading motor data...</p>
                        </div>
                        <!-- END NEW FILTERS -->

                        <div class="admin-button-group" style="margin-top: 1.5em;">
                            <button id="generateCsvButton">Generate and Download CSV Report</button>
                        </div>
                        <div id="csv-generation-status" style="font-style: italic; color: #555;"></div>
                    </div>
                    <!-- =================================================================== -->
                    <!-- END: NEW SECTION FOR CSV REPORT GENERATION                          -->
                    <!-- =================================================================== -->
                </div>

            </div>
        </div>
    </div>
    
    <script>
        let lathData = [], axleData = [], motorData = [], bottomLathData = [], safetyBrakeData = [], endplateData = [], wicketData = [], endlockData = [], guideData = [];
        let lathImageMap = new Map();
        let safetyBrakeImageMap = new Map();
        let currentFilteredMotors = [], currentFilteredEndplates = [];
        let calculatedRotations = 0, maxCoilDiameter = 0;
        let lastTorqueProfile = [];
        let userSelectedAxleIndex = null;
        let visionCalcs = null; 
        
        const dom = {};
        ['width', 'widthType', 'guideType', 'additionalLength', 'height', 'lathType', 'bottomLathType', 'axleType', 'friction', 'import-status', 
         'total-axle-length', 'weight-kg', 'axle-deflection', 'deflection-ratio', 'ratio-paragraph', 
         'recommendation-box', 'deflection-graphic-container', 'torque-graph-container', 'lath-count', 'laths-to-lift',
         'max-torque', 'total-revolutions', 'motorMountingType', 'motorVoltageFilter', 'motorManufacturerFilter', 'motorSelector', 'motor-name', 'motor-torque', 'motor-rpm', 
         'opening-time', 'motor-torque-line', 'axle-weight', 'axle-material-grade', 'moment-of-inertia', 'total-deflection-weight',
         'safety-brake-force-kn', 'safety-brake-force-kg', 'safety-brake-torque', 'safety-brake-name', 'sb-mass', 'sb-fall-dist', 'sb-stop-dist',
         'sb-activation-height', 'sb-activation-height-explainer', 'safetyBrakeSelector', 'shutter-graphic-container', 'safety-brake-driveshaft',
         'curtain-height-extended', 'curtain-height-compressed', 'endplateSelector', 'matSteel', 'matAluminium', 'endplate-name', 'endplate-size',
         'endplate-material', 'max-coil-diameter', 'prev-endplate-name', 'prev-endplate-height', 'next-endplate-name', 'next-endplate-height',
         'width-warning', 'curtain-area', 'lifted-curtain-area', 'printButton', 'wicketDoorSelector', 'wicket-door-name', 'wicket-door-height', 'wicket-door-width',
         'wicket-graphic-container', 'laths-at-wicket', 'wicket-lath-height', 'wicket-max-torque', 'wicket-torque-graph-container',
         'addVision', 'vision-slat-options', 'visionLathType', 'visionStartHeight', 'visionPanelHeight', 'axle-safety-factor', 'power-consumed',
         'powderCoated', 'axle-cross-section-container', 'visionLathImageDisplay', 'safety-brake-capacity', 
         'safety-brake-image-container', 'safetyBrakeImageDisplay', 'endplate-graphic-container', 'endplate-downward-force', 
         'endplate-pullout-force', 'endplate-force-diagram-container', 'includeDeflectionInSizing', 'effective-coil-para', 'effective-coil-diameter', 'collarSize',
         'vision-percentage', 'vision-percentage-para', 'vision-area-m2', 'vision-area-m2-para', 'endlockType', 'endlock-weight',
         'admin-content', 'tab-content', 'importCsvButton', 'shapeCircular', 'shapeOctagonal', 'collar-size-group', 'torque-weight-kg',
         'useCustomLath', 'custom-lath-options', 'customLathWeight', 'customTorqueWeight', 'max-torque-inputs', 'motor-name-inputs', 'motor-torque-inputs', 'motor-torque-line-inputs',
         'width-graphic-container', 'calculated-curtain-width', 'calculated-clear-opening', 'calculated-overall-width'
        ].forEach(id => dom[id] = document.getElementById(id));
        
        const tabButtons = document.querySelectorAll('.tab-button');
        
        ['width', 'widthType', 'guideType', 'additionalLength', 'height', 'friction', 'motorMountingType', 'motorVoltageFilter', 'motorManufacturerFilter', 'bottomLathType', 'lathType', 'matSteel', 'matAluminium',
         'visionLathType', 'visionStartHeight', 'visionPanelHeight', 'powderCoated', 'includeDeflectionInSizing', 'collarSize', 'endlockType',
         'useCustomLath', 'customLathWeight', 'customTorqueWeight'
        ].forEach(id => {
            if (dom[id]) dom[id].addEventListener('input', () => {
                userSelectedAxleIndex = null; 
                if (id === 'useCustomLath') {
                    const isChecked = dom.useCustomLath.checked;
                    dom['custom-lath-options'].style.display = isChecked ? 'block' : 'none';
                    dom.lathType.disabled = isChecked;
                }
                if (id === 'lathType' && lathData.length > 0) {
                    const selectedLath = lathData[dom.lathType.value];
                    if (selectedLath) {
                        if (selectedLath['Friction %'] !== undefined) {
                            dom.friction.value = selectedLath['Friction %'];
                        }
                        const lathName = (selectedLath['Name'] || '').toLowerCase();
                        if (lathName.includes('wind')) {
                           const endlockSelect = dom.endlockType;
                           for (let i = 0; i < endlockSelect.options.length; i++) {
                               if (endlockSelect.options[i].text.toLowerCase().includes('75mm cast')) {
                                   endlockSelect.value = endlockSelect.options[i].value;
                                   break;
                               }
                           }
                        }
                    }
                }
                updateAllCalculations();
            });
        });

        dom.addVision.addEventListener('change', () => {
            dom['vision-slat-options'].style.display = dom.addVision.checked ? 'block' : 'none';
            updateAllCalculations();
        });

        ['shapeCircular', 'shapeOctagonal'].forEach(id => {
            if (dom[id]) dom[id].addEventListener('change', handleShapeChange);
        });

        dom.motorSelector.addEventListener('change', updateSelectedMotorInfo);
        dom.endplateSelector.addEventListener('change', updateSelectedEndplateInfo);
        tabButtons.forEach(button => button.addEventListener('click', () => switchTab(button.dataset.tab)));
        dom.safetyBrakeSelector.addEventListener('input', updateSelectedSafetyBrakeInfo);
        dom.axleType.addEventListener('input', handleAxleOverride);
        dom.wicketDoorSelector.addEventListener('input', updateSelectedWicketInfo);
        dom.printButton.addEventListener('click', () => {
            window.print();
        });
        dom.importCsvButton.addEventListener('click', handleCsvImport);

        function updatePrintStyles() {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                const tabButton = document.querySelector(`.tab-button[data-tab="${pane.id}"]`);
                if (tabButton && tabButton.style.display === 'none') {
                    pane.classList.add('hide-in-print');
                } else {
                    pane.classList.remove('hide-in-print');
                }
            });
        }

        // Admin Page Logic
        function initializeAdminControls() {
            const tabContainer = document.getElementById('tab-controls-container');
            const inputContainer = document.getElementById('input-controls-container');
            tabContainer.innerHTML = '';
            inputContainer.innerHTML = '';

            // Generate Tab Controls
            document.querySelectorAll('.tab-button').forEach(tab => {
                const tabId = tab.dataset.tab;
                const labelText = tab.textContent.trim();
                const controlItem = document.createElement('div');
                controlItem.className = 'admin-control-item';
                
                const isChecked = tab.style.display !== 'none';

                controlItem.innerHTML = `
                    <label>
                        <input type="checkbox" data-target-tab="${tabId}" ${isChecked ? 'checked' : ''}>
                        ${labelText}
                    </label>
                `;
                tabContainer.appendChild(controlItem);

                controlItem.querySelector('input').addEventListener('change', (e) => {
                    tab.style.display = e.target.checked ? '' : 'none';
                    updatePrintStyles(); // Update print styles on change
                });
            });

            // Generate Input Controls
            document.querySelectorAll('[data-admin-label]').forEach((inputGroup, index) => {
                const labelText = inputGroup.dataset.adminLabel;
                const groupId = `admin-input-${index}`;
                inputGroup.id = groupId; // Ensure the target has an ID

                const controlItem = document.createElement('div');
                controlItem.className = 'admin-control-item';
                controlItem.innerHTML = `
                    <label>
                        <input type="checkbox" data-target-input="${groupId}" checked>
                        ${labelText}
                    </label>
                `;
                inputContainer.appendChild(controlItem);
                 
                 controlItem.querySelector('input').addEventListener('change', (e) => {
                    inputGroup.style.display = e.target.checked ? '' : 'none';
                });
            });

            const setupBulkActions = (selectAllId, deselectAllId, containerId) => {
                document.getElementById(selectAllId).addEventListener('click', () => {
                    document.querySelectorAll(`#${containerId} input[type="checkbox"]`).forEach(cb => {
                        if (!cb.checked) {
                            cb.checked = true;
                            cb.dispatchEvent(new Event('change'));
                        }
                    });
                });
                document.getElementById(deselectAllId).addEventListener('click', () => {
                    document.querySelectorAll(`#${containerId} input[type="checkbox"]`).forEach(cb => {
                        if (cb.checked) {
                            cb.checked = false;
                            cb.dispatchEvent(new Event('change'));
                        }
                    });
                });
            };

            setupBulkActions('tabsSelectAll', 'tabsDeselectAll', 'tab-controls-container');
            setupBulkActions('inputsSelectAll', 'inputsDeselectAll', 'input-controls-container');
            updatePrintStyles(); // Set initial print styles on load
        }

        function handleShapeChange() {
            const selectedShape = document.querySelector('input[name="axleShape"]:checked').value;
            const collarGroup = dom['collar-size-group'];

            if (selectedShape === 'octagonal') {
                collarGroup.style.display = 'block';
            } else {
                collarGroup.style.display = 'none';
                dom.collarSize.value = 0; // Reset value when hidden to avoid calculation errors
            }
            
            userSelectedAxleIndex = null; // Reset user override when shape changes
            updateAllCalculations();
        }

        function handleAxleOverride() {
            if (dom.axleType.value !== "") {
                userSelectedAxleIndex = dom.axleType.value; 
                updateAllCalculations(); 
            }
        }
        
        async function processExcelFile(fileData) {
            userSelectedAxleIndex = null; 
            try {
                const workbook = XLSX.read(new Uint8Array(fileData), { type: 'array' });
                
                const required = {
                    'Lath': ['Name', 'Kgs/ m2', 'Thickness', 'Compressed lath height', 'uncompressed lath height', 'Friction %', 'Max Width', 'Lath image', 'Moment of inertia iy', 'Allowable Bending Stress (MPa)', 'vision percentage'],
                    'Bottom lath': ['Bottom lath name', 'BLath weight / m length', 'BLath height'],
                    'Axles': ['Name', 'Diameter', 'Wall Thickness', 'Material grade', "Density (kg/m3)", 'Shape'],
                    'Motors': ['Name', 'Torque (Nm) min', 'Torque (Nm) max', 'RPM', 'Mounting type', 'Wattage', 'Voltage', 'Manufacturer'],
                    'SafetyB': ['Name', 'Max Safety Torque (Nm)', 'Driveshaft diameter mm', 'Stop distance', 'SB image'],
                    'Endplate': ['Name', 'Size', 'Material', 'Fixing holes'],
                    'Wicket doors': ['Name', 'Height', 'Width'],
                    'Endlock': ['Description', 'Weight in grams', 'end lock offset'],
                    'Guides': ['Name', 'Width', 'Penetration']
                };

                for (const sheetName in required) {
                    if (!workbook.Sheets[sheetName]) {
                        if (sheetName === 'Wicket doors' || sheetName === 'Endlock') {
                            console.warn(`Optional sheet "${sheetName}" not found.`);
                            if(sheetName === 'Wicket doors') wicketData = [];
                            if(sheetName === 'Endlock') endlockData = [];
                            continue;
                        }
                         const coreRequired = {
                            'Lath': ['Name', 'Kgs/ m2', 'Thickness', 'Compressed lath height', 'uncompressed lath height', 'Moment of inertia iy', 'Allowable Bending Stress (MPa)'],
                            'Bottom lath': ['Bottom lath name', 'BLath weight / m length'],
                            'Axles': ['Name', 'Diameter', 'Wall Thickness'],
                            'Motors': ['Name', 'Torque (Nm) max', 'Mounting type', 'Manufacturer'],
                            'SafetyB': ['Name', 'Max Safety Torque (Nm)'],
                            'Endplate': ['Name', 'Size', 'Material'],
                            'Wicket doors': ['Name', 'Height', 'Width'],
                            'Endlock': ['Description', 'Weight in grams', 'end lock offset'],
                            'Guides': ['Name', 'Width', 'Penetration']
                        };
                        const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                        if (sheetData.length > 0) {
                            const headerRow = sheetData[0].map(h => String(h).toLowerCase().trim());
                            for (const requiredCol of coreRequired[sheetName]) {
                                if (!headerRow.includes(requiredCol.toLowerCase().trim())) {
                                    throw new Error(`Required column "${requiredCol}" not found in sheet "${sheetName}".`);
                                }
                            }
                        } else {
                           throw new Error(`Required sheet "${sheetName}" not found or is empty in the Excel file.`);
                        }
                    }
                    
                    const objectData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    switch (sheetName) {
                        case 'Lath': lathData = objectData; break;
                        case 'Bottom lath': bottomLathData = objectData; break;
                        case 'Axles': axleData = objectData; break;
                        case 'Motors': motorData = objectData; break;
                        case 'SafetyB': safetyBrakeData = objectData; break;
                        case 'Endplate': endplateData = objectData; break;
                        case 'Wicket doors': wicketData = objectData; break;
                        case 'Endlock': endlockData = objectData; break;
                        case 'Guides': guideData = objectData; break;
                    }
                }

                lathImageMap.clear(); 
                safetyBrakeImageMap.clear();
                const exceljsWorkbook = new ExcelJS.Workbook();
                await exceljsWorkbook.xlsx.load(fileData);

                const lathSheet = exceljsWorkbook.getWorksheet('Lath');
                if (lathSheet) {
                    await extractImagesFromSheet(exceljsWorkbook, lathSheet, 'name', 'lath image', lathImageMap);
                }
                
                const safetyBrakeSheet = exceljsWorkbook.getWorksheet('SafetyB');
                if (safetyBrakeSheet) {
                    await extractImagesFromSheet(exceljsWorkbook, safetyBrakeSheet, 'name', 'sb image', safetyBrakeImageMap);
                }
                
                populateDropdown(dom.lathType, lathData, 'Name');
                populateDropdown(dom.guideType, guideData, 'Name');
                const visionSelect = dom.visionLathType;
                visionSelect.innerHTML = `<option value="">-- Select a vision lath --</option>`;
                lathData.forEach((item, index) => {
                    const visionKey = Object.keys(item).find(k => k.toLowerCase().trim() === 'vision percentage');
                    const visionValue = visionKey ? (parseFloat(item[visionKey]) || 0) : 0;
                    if (visionValue > 0) {
                        const option = document.createElement('option');
                        option.value = index;
                        const nameKey = Object.keys(item).find(k => k.toLowerCase().trim() === 'name');
                        option.textContent = item[nameKey];
                        visionSelect.appendChild(option);
                    }
                });
                populateDropdown(dom.bottomLathType, bottomLathData, 'Bottom lath name');
                populateDropdown(dom.endlockType, endlockData, 'Description');
                populateMotorMountingTypes();
                populateMotorVoltageFilter();
                populateMotorManufacturerFilter();
                populateDropdown(dom.wicketDoorSelector, wicketData, 'Name');

                ['lathType', 'guideType', 'bottomLathType', 'visionLathType', 'motorMountingType', 'motorVoltageFilter', 'motorManufacturerFilter', 'safetyBrakeSelector', 'axleType', 'endplateSelector', 'wicketDoorSelector', 'endlockType'].forEach(id => {
                    if(dom[id]) dom[id].disabled = false;
                });

                updateSelectedWicketInfo(); 
                dom['import-status'].textContent = 'Successfully loaded data from repository.';
                dom['import-status'].style.color = 'green';
                updateAllCalculations();
                
                // --- NEW: Populate the report filters now that data is loaded ---
                setupReportFilters();

            } catch (error) {
                dom['import-status'].textContent = `Error processing Excel file: ${error.message}`;
                dom['import-status'].style.color = 'red';
                alert(`Error Reading File: ${error.message}`);
                lathData = []; axleData = []; motorData = []; bottomLathData = []; safetyBrakeData = []; endplateData = []; wicketData = []; endlockData = []; guideData = [];
            }
        }

        // CSV Import Logic
        function handleCsvImport() {
            const csvFileInput = document.getElementById('csvFileInput');
            const statusDiv = document.getElementById('import-status-admin');
            
            if (!csvFileInput.files || csvFileInput.files.length === 0) {
                statusDiv.textContent = 'Please select a CSV file first.';
                statusDiv.style.color = 'red';
                return;
            }

            const file = csvFileInput.files[0];
            statusDiv.textContent = 'Importing...';
            statusDiv.style.color = '#555';

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        statusDiv.textContent = `Error parsing CSV: ${results.errors[0].message}`;
                        statusDiv.style.color = 'red';
                        return;
                    }
                    if (results.data.length === 0) {
                        statusDiv.textContent = 'CSV file is empty or contains only headers.';
                        statusDiv.style.color = 'red';
                        return;
                    }
                    
                    populateFieldsFromCsv(results.data[0]);
                    statusDiv.textContent = `Successfully imported data for "${results.data[0].Calculation_ID || 'N/A'}".`;
                    statusDiv.style.color = 'green';
                },
                error: function(err) {
                     statusDiv.textContent = `An error occurred: ${err}`;
                     statusDiv.style.color = 'red';
                }
            });
        }

        function populateFieldsFromCsv(data) {
            const getVal = (key) => (data[key] || '').trim();

            const mappings = {
                'Curtain_Width_mm': { id: 'width', type: 'number' },
                'Curtain_Height_mm': { id: 'height', type: 'number' },
                'Additional_Axle_Width_mm': { id: 'additionalLength', type: 'number' },
                'Collar_Size_mm': { id: 'collarSize', type: 'number' },
                'Friction_Allowance_Percent': { id: 'friction', type: 'number' },
                'Vision_Start_Height_mm': { id: 'visionStartHeight', type: 'number' },
                'Vision_Panel_Height_mm': { id: 'visionPanelHeight', type: 'number' },

                'Is_Powder_Coated': { id: 'powderCoated', type: 'checkbox' },
                'Has_Vision_Slats': { id: 'addVision', type: 'checkbox' },
                'Include_Deflection_In_Sizing': { id: 'includeDeflectionInSizing', type: 'checkbox' },

                'Lath_Type_Name': { id: 'lathType', type: 'select' },
                'Endlock_Type_Name': { id: 'endlockType', type: 'select' },
                'Bottom_Lath_Name': { id: 'bottomLathType', type: 'select' },
                'Vision_Lath_Name': { id: 'visionLathType', type: 'select' },
                'Motor_Mounting_Type': { id: 'motorMountingType', type: 'select' },
                'Wicket_Door_Name': { id: 'wicketDoorSelector', type: 'select' },
                
                'Endplate_Material': { name: 'material', type: 'radio' },
            };

            for (const key in mappings) {
                const value = getVal(key);
                if (value === '') continue;

                const config = mappings[key];
                
                switch (config.type) {
                    case 'number':
                        const numEl = document.getElementById(config.id);
                        if (numEl) numEl.value = value;
                        break;
                    case 'checkbox':
                        const checkEl = document.getElementById(config.id);
                        if (checkEl) checkEl.checked = (value.toLowerCase() === 'true');
                        break;
                    case 'select':
                        const selectEl = document.getElementById(config.id);
                        if (selectEl) {
                            for (let i = 0; i < selectEl.options.length; i++) {
                                if (selectEl.options[i].text.trim() === value.trim()) {
                                    selectEl.value = selectEl.options[i].value;
                                    break;
                                }
                            }
                        }
                        break;
                    case 'radio':
                        const radioEl = document.querySelector(`input[name="${config.name}"][value="${value}"]`);
                        if (radioEl) radioEl.checked = true;
                        break;
                }
            }

            // Manually trigger change events for checkboxes that control visibility
            dom.addVision.dispatchEvent(new Event('change'));

            updateAllCalculations();
            
            // Switch back to the inputs tab to show the user the result
            switchTab('inputs-content');
        }

        async function extractImagesFromSheet(workbook, sheet, nameColHeader, imageColHeader, imageMap) {
            let nameCol = -1, imageCol = -1;
            const headerRow = sheet.getRow(1);
            headerRow.eachCell((cell, colNumber) => {
                const headerText = cell.value ? cell.value.toString().toLowerCase().trim() : '';
                if (headerText === nameColHeader) nameCol = colNumber;
                if (headerText === imageColHeader) imageCol = colNumber;
            });

            if (nameCol > 0 && imageCol > 0) {
                const images = sheet.getImages();
                images.forEach(image => {
                    const imageRowNumber = image.range.tl.row + 1;
                    const nameCell = sheet.getCell(imageRowNumber, nameCol);
                    if (nameCell && nameCell.value) {
                        const name = nameCell.value.toString();
                        const imgData = workbook.getImage(image.imageId);
                        const base64Image = btoa(new Uint8Array(imgData.buffer).reduce((data, byte) => data + String.fromCharCode(byte), ''));
                        const imageSrc = `data:image/${imgData.extension};base64,${base64Image}`;
                        imageMap.set(name, imageSrc);
                    }
                });
            }
        }

        function populateMotorMountingTypes() {
            const mountingTypes = [...new Set(motorData.map(motor => motor['Mounting type']))];
            const select = dom.motorMountingType;
            select.innerHTML = '<option value="">-- All Types --</option>';
            mountingTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
        }
        
        function populateMotorVoltageFilter() {
            let voltageKey = '';
            if (motorData.length > 0) {
                voltageKey = Object.keys(motorData[0]).find(k => k.toLowerCase().trim() === 'voltage');
            }

            if (!voltageKey) {
                console.warn('Voltage column not found in motor data.');
                dom.motorVoltageFilter.parentElement.style.display = 'none'; // Hide the filter if no data
                return;
            }

            const voltageTypes = [...new Set(motorData.map(motor => motor[voltageKey]).filter(v => v))];
            const select = dom.motorVoltageFilter;
            select.innerHTML = '<option value="">-- All Voltages --</option>';
            voltageTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
            dom.motorVoltageFilter.parentElement.style.display = 'block';
        }

        function populateMotorManufacturerFilter() {
            let manufacturerKey = '';
            if (motorData.length > 0) {
                manufacturerKey = Object.keys(motorData[0]).find(k => k.toLowerCase().trim() === 'manufacturer');
            }

            if (!manufacturerKey) {
                console.warn('Manufacturer column not found in motor data. The filter will not be displayed.');
                dom.motorManufacturerFilter.parentElement.style.display = 'none';
                return;
            }

            const manufacturers = [...new Set(motorData.map(motor => motor[manufacturerKey]).filter(m => m))];
            const select = dom.motorManufacturerFilter;
            select.innerHTML = '<option value="">-- All Manufacturers --</option>';
            manufacturers.sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
            dom.motorManufacturerFilter.parentElement.style.display = 'block';
        }

        function getLathWithCustomWeight() {
            let selectedLath = lathData[dom.lathType.value];
            if (!selectedLath) return null; // Need a base lath

            if (dom.useCustomLath.checked) {
                const customWeight = parseFloat(dom.customLathWeight.value);
                if (!isNaN(customWeight) && customWeight > 0) {
                    // Create a copy of the selected lath and override its weight
                    let customLath = { ...selectedLath };
                    const weightKey = Object.keys(customLath).find(k => k.toLowerCase().trim() === 'kgs/ m2');
                    if (weightKey) {
                        customLath[weightKey] = customWeight;
                    } else {
                        customLath['Kgs/ m2'] = customWeight;
                    }
                    return customLath;
                }
            }
            return selectedLath;
        }

        function getCalculatedWidths() {
            const inputWidth = parseFloat(dom.width.value) || 0;
            const widthType = dom.widthType.value;
            const selectedGuideIndex = dom.guideType.value;
            
            let curtainWidth = 0;
            let clearOpening = 0;
            let overallWidth = 0;

            if (selectedGuideIndex !== "" && guideData[selectedGuideIndex]) {
                const guide = guideData[selectedGuideIndex];
                const penetrationKey = Object.keys(guide).find(k => k.toLowerCase().trim() === 'penetration');
                const widthKey = Object.keys(guide).find(k => k.toLowerCase().trim() === 'width');
                
                const guidePenetration = parseFloat(guide[penetrationKey]) || 0;
                const guideWidth = parseFloat(guide[widthKey]) || 0;

                if (widthType === 'curtainWidth') {
                    curtainWidth = inputWidth;
                    clearOpening = curtainWidth - (2 * guidePenetration);
                    overallWidth = clearOpening + (2 * guideWidth);
                } else if (widthType === 'clearOpening') {
                    clearOpening = inputWidth;
                    curtainWidth = clearOpening + (2 * guidePenetration);
                    overallWidth = clearOpening + (2 * guideWidth);
                } else if (widthType === 'overall') {
                    overallWidth = inputWidth;
                    clearOpening = overallWidth - (2 * guideWidth);
                    curtainWidth = clearOpening + (2 * guidePenetration);
                }
            } else {
                // Fallback if no guide is selected
                curtainWidth = inputWidth;
                clearOpening = inputWidth;
                overallWidth = inputWidth;
            }

            dom['calculated-curtain-width'].textContent = curtainWidth.toFixed(0);
            dom['calculated-clear-opening'].textContent = clearOpening.toFixed(0);
            dom['calculated-overall-width'].textContent = overallWidth.toFixed(0);

            return { curtainWidth, clearOpening, overallWidth };
        }


        function updateAllCalculations() {
            if (lathData.length === 0) {
                return;
            };

            const calculatedWidths = getCalculatedWidths();
            const curtainWidth = calculatedWidths.curtainWidth;
            const effectiveLath = getLathWithCustomWeight();

            const lathImageContainer = document.getElementById('lath-image-container');
            const lathImageDisplay = document.getElementById('lathImageDisplay');
            
            if (effectiveLath) {
                const selectedLathName = effectiveLath['Name'];
                if (lathImageMap.has(selectedLathName)) {
                    lathImageDisplay.src = lathImageMap.get(selectedLathName);
                    lathImageContainer.style.display = dom.useCustomLath.checked ? 'none' : 'block';
                } else {
                    lathImageContainer.style.display = 'none';
                }
            } else {
                lathImageContainer.style.display = 'none';
            }

            const visionLathImageContainer = document.getElementById('vision-lath-image-container');
            const visionLathImageDisplay = document.getElementById('visionLathImageDisplay');
            if (dom.addVision.checked) {
                const selectedVisionLathIndex = dom.visionLathType.value;
                 if (selectedVisionLathIndex && lathData[selectedVisionLathIndex]) {
                    const selectedVisionLathName = lathData[selectedVisionLathIndex]['Name'];
                    if (lathImageMap.has(selectedVisionLathName)) {
                        visionLathImageDisplay.src = lathImageMap.get(selectedVisionLathName);
                        visionLathImageContainer.style.display = 'block';
                    } else {
                        visionLathImageContainer.style.display = 'none';
                    }
                } else {
                    visionLathImageContainer.style.display = 'none';
                }
            } else {
                 visionLathImageContainer.style.display = 'none';
            }

            const widthWarningDiv = dom['width-warning'];
            if (effectiveLath) {
                const maxWidthKey = Object.keys(effectiveLath).find(k => k.toLowerCase().trim() === 'max width');
                const maxWidth = maxWidthKey ? parseFloat(effectiveLath[maxWidthKey]) : 0;
                
                if (maxWidth > 0 && curtainWidth > maxWidth && !dom.useCustomLath.checked) {
                    widthWarningDiv.textContent = `Warning: Calculated curtain width (${curtainWidth.toFixed(0)} mm) exceeds the maximum of ${maxWidth} mm for this lath type.`;
                    widthWarningDiv.style.display = 'block';
                } else {
                    widthWarningDiv.style.display = 'none';
                }
            } else {
                widthWarningDiv.style.display = 'none';
            }
            
            if (axleData.length === 0 || safetyBrakeData.length === 0) {
                drawDeflectionGraphic(0, 0);
                drawAxleCrossSection(null);
                calculateSafetyBrakeForce();
                drawShutterGraphic(); 
                return;
            };
            
            const selectedBottomLath = bottomLathData[dom.bottomLathType.value];
            
            const estCurtainProps = calculateCurtainProperties(effectiveLath, selectedBottomLath, null, curtainWidth);
            const { bestAxle } = findAndSetBestAxle(estCurtainProps.totalWeight, curtainWidth);

            const finalCurtainProps = calculateCurtainProperties(effectiveLath, selectedBottomLath, bestAxle, curtainWidth);
            const { totalWeight, torqueWeight, travelHeight, fullCurtainLength, visionData, endlockOffsets } = finalCurtainProps;
            visionCalcs = visionData;
            
            calculateEndplateRecommendation(); 

            const { deflection, totalLength } = findAndSetBestAxle(totalWeight, curtainWidth);

            drawDeflectionGraphic(totalLength, deflection);
            calculateMotorRecommendation(torqueWeight, effectiveLath, bestAxle, travelHeight, curtainWidth);
            calculateSafetyBrakeForce(totalWeight, effectiveLath, bestAxle, travelHeight, fullCurtainLength);
            
            const selectedEndplateIndex = dom.endplateSelector.value;
            const selectedEndplate = (selectedEndplateIndex !== "" && currentFilteredEndplates[selectedEndplateIndex]) 
                ? currentFilteredEndplates[selectedEndplateIndex] 
                : null;

            drawShutterGraphic(
                curtainWidth,
                parseFloat(dom.additionalLength.value),
                parseInt(dom['lath-count'].textContent),
                effectiveLath,
                selectedBottomLath,
                bestAxle,
                selectedEndplate,
                visionData,
                endlockOffsets
            );
            
            const selectedGuide = guideData.length > 0 ? guideData[dom.guideType.value] : null;
            drawTopDownWidthGraphic(calculatedWidths, selectedGuide);

            updateWicketCalculationsAndGraphic(endlockOffsets, curtainWidth);
        }
        
        function findAndSetBestAxle(totalWeightKgs, curtainWidth) {
            const width = curtainWidth || 0;
            const additionalLength = parseFloat(dom.additionalLength.value) || 0;
            const totalLength = width + additionalLength;
            dom['total-axle-length'].textContent = totalLength.toFixed(0);

            const selectedShape = document.querySelector('input[name="axleShape"]:checked')?.value || 'circular';

            if (totalLength <= 0 || axleData.length === 0) {
                 ['axle-deflection', 'deflection-ratio', 'axle-weight', 'moment-of-inertia', 'total-deflection-weight', 'axle-safety-factor'].forEach(id => dom[id].textContent = '0.00');
                dom['axle-material-grade'].textContent = 'N/A';
                dom.axleType.innerHTML = '<option>-- No data --</option>';
                drawAxleCrossSection(null);
                return { bestAxle: null, deflection: 0, totalLength: 0 };
            }

            const axlesForShape = axleData
                .map((axle, index) => ({ ...axle, originalIndex: index }))
                .filter(axle => {
                    const axleShapeInSheet = (axle.Shape || 'circular').toLowerCase().trim();
                    return axleShapeInSheet === selectedShape;
                });

            if (axlesForShape.length === 0) {
                dom.axleType.innerHTML = `<option>-- No ${selectedShape} axles available --</option>`;
                ['axle-deflection', 'deflection-ratio', 'axle-weight', 'moment-of-inertia', 'total-deflection-weight', 'axle-safety-factor'].forEach(id => dom[id].textContent = '0.00');
                dom['axle-material-grade'].textContent = 'N/A';
                drawAxleCrossSection(null);
                return { bestAxle: null, deflection: 0, totalLength: 0 };
            }

            let recommendedAxleOriginalIndex = -1;
            const axlePerformances = [];

            axlesForShape.forEach(currentAxle => {
                const perf = performDeflectionCalc(totalWeightKgs, currentAxle, totalLength);
                axlePerformances.push(perf);
                const passesTest = perf.ratio >= 400 && perf.deflection <= 25;
                if (passesTest && recommendedAxleOriginalIndex === -1) {
                    recommendedAxleOriginalIndex = currentAxle.originalIndex;
                }
            });

            if (recommendedAxleOriginalIndex === -1) {
                recommendedAxleOriginalIndex = axlesForShape.length > 0 ? axlesForShape[0].originalIndex : -1;
            }

            let finalSelectedOriginalIndex = userSelectedAxleIndex !== null ? userSelectedAxleIndex : recommendedAxleOriginalIndex;
            
            const isUserSelectionValidForShape = axlesForShape.some(axle => axle.originalIndex == finalSelectedOriginalIndex);
            if (userSelectedAxleIndex !== null && !isUserSelectionValidForShape) {
                finalSelectedOriginalIndex = recommendedAxleOriginalIndex;
            }

            const select = dom.axleType;
            select.innerHTML = '';
            axlesForShape.forEach((axle, index) => {
                const perf = axlePerformances[index];
                const option = document.createElement('option');
                option.value = axle.originalIndex;
                let optionText = axle['Name'];
                if (axle['Alternate name']) optionText += ` (${axle['Alternate name']})`;
                option.textContent = optionText;
                
                const passesTest = perf.ratio >= 400 && perf.deflection <= 25;
                option.classList.toggle('option-pass', passesTest);
                option.classList.toggle('option-fail', !passesTest);
                
                select.appendChild(option);
            });
            
            if (finalSelectedOriginalIndex > -1) {
                select.value = finalSelectedOriginalIndex;
            }
            
            const selectedAxleData = axleData[select.value];
            if (!selectedAxleData) {
                drawAxleCrossSection(null);
                return { bestAxle: null, deflection: 0, totalLength };
            }

            const finalPerformance = performDeflectionCalc(totalWeightKgs, selectedAxleData, totalLength);
            
            dom['axle-weight'].textContent = finalPerformance.axleWeight.toFixed(2);
            const totalDeflectionWeight = totalWeightKgs + finalPerformance.axleWeight;
            dom['total-deflection-weight'].textContent = totalDeflectionWeight.toFixed(2);

            dom['axle-material-grade'].textContent = finalPerformance.materialGradeValue ? `${finalPerformance.materialGradeValue} MPa` : 'N/A';
            dom['moment-of-inertia'].textContent = finalPerformance.inertiaI.toLocaleString(undefined, { maximumFractionDigits: 2 });
            dom['axle-deflection'].textContent = finalPerformance.deflection.toFixed(2);
            dom['deflection-ratio'].textContent = (finalPerformance.ratio !== Infinity) ? `1 : ${Math.round(finalPerformance.ratio)}` : 'N/A';
            dom['axle-safety-factor'].textContent = isFinite(finalPerformance.safetyFactor) ? finalPerformance.safetyFactor.toFixed(2) : 'Very High';

            if (finalPerformance.ratio < 400 || finalPerformance.deflection > 25) {
                dom['ratio-paragraph'].classList.add('warning-text');
                dom['axle-safety-factor'].parentElement.classList.add('warning-text');
                dom['recommendation-box'].style.display = 'block';

                const nextBest = axlesForShape.find(axle => {
                    const perf = performDeflectionCalc(totalWeightKgs, axle, totalLength);
                    return perf.ratio >= 400 && perf.deflection <= 25;
                });

                if (nextBest) {
                    dom['recommendation-box'].innerHTML = `⚠️ <strong>Warning:</strong> Selected axle may fail. Consider using <strong>${nextBest['Name']}</strong>.`;
                } else {
                    dom['recommendation-box'].innerHTML = `⚠️ <strong>Critical Warning:</strong> No available ${selectedShape} axle passes the deflection test for this specification.`;
                }
            } else {
                dom['ratio-paragraph'].classList.remove('warning-text');
                dom['axle-safety-factor'].parentElement.classList.remove('warning-text');
                dom['recommendation-box'].style.display = 'none';
            }

            const collarSize = parseFloat(dom.collarSize.value) || 0;
            drawAxleCrossSection(selectedAxleData, collarSize);
            
            return { bestAxle: selectedAxleData, deflection: finalPerformance.deflection, totalLength };
        }

        function performDeflectionCalc(totalWeightKgs, axle, totalLength, fixityPercent = 0) {
            if (!axle) return { deflection: 0, ratio: Infinity, safetyFactor: Infinity, axleWeight: 0, materialGradeValue: 'N/A', inertiaI: 0 };
            
            const outerDia = parseFloat(axle['Diameter']);
            const wallThick = parseFloat(axle['Wall Thickness']);
            const shape = (axle['Shape'] || 'circular').toLowerCase();
            const lengthM = totalLength / 1000;
            const density = parseFloat(axle['Density (kg/m3)']) || 0;
            const materialGradeValue = axle['Material grade'];
            const youngsModulusE = parseFloat(materialGradeValue) || 199000;
            
            let inertiaI = 0;
            let axleWeight = 0;

            if (shape === 'octagonal') {
                const Do = outerDia;
                const Di = Do - 2 * wallThick;
                inertiaI = ((11 + 8 * Math.sqrt(2)) / 192) * (Math.pow(Do, 4) - Math.pow(Di, 4));

                const outerArea = 2 * (Math.sqrt(2) - 1) * Math.pow(Do, 2);
                const innerArea = 2 * (Math.sqrt(2) - 1) * Math.pow(Di, 2);
                const hollowArea_mm2 = outerArea - innerArea;
                const volume_m3 = (hollowArea_mm2 / 1000000) * lengthM;
                axleWeight = volume_m3 * density;
                
            } else { // Circular
                inertiaI = (Math.PI / 64) * (Math.pow(outerDia, 4) - Math.pow(outerDia - 2 * wallThick, 4));
                const outerRadiusM = outerDia / 2 / 1000;
                const innerRadiusM = (outerDia - 2 * wallThick) / 2 / 1000;
                const volumeM3 = Math.PI * (Math.pow(outerRadiusM, 2) - Math.pow(innerRadiusM, 2)) * lengthM;
                axleWeight = volumeM3 * density;
            }
            
            const totalForceW = (totalWeightKgs + axleWeight) * 9.81;
            let deflection = (totalLength > 0 && inertiaI > 0 && youngsModulusE > 0) 
                ? (5 * totalForceW * Math.pow(totalLength, 3)) / (384 * youngsModulusE * inertiaI) 
                : 0;
            
            // Apply Fixity Scaling
            // Simply Supported = 5/384 (Factor 1.0)
            // Fixed = 1/384 (Factor 0.2)
            if (fixityPercent > 0) {
                const factor = 1 - (0.8 * (Math.min(100, Math.max(0, fixityPercent)) / 100));
                deflection *= factor;
            }

            const ratio = (deflection > 0) ? totalLength / deflection : Infinity;
            const safetyFactor = ratio / 400;

            return { deflection, ratio, safetyFactor, axleWeight, materialGradeValue, inertiaI };
        }
        
        function getEffectiveCoilDiameter(axle) {
            if (!axle) return 0;
            const shape = (axle['Shape'] || 'circular').toLowerCase();
            const diameter = parseFloat(axle['Diameter']) || 0;
            
            if (shape === 'octagonal') {
                return diameter / Math.cos(Math.PI / 8);
            }
            return diameter;
        }
        
        // ===================================================================
        // START: UPDATED CODE FOR CSV REPORT GENERATION
        // ===================================================================
        
        // This function sets up the dropdowns and filter checkboxes once data is loaded
        function setupReportFilters() {
            // 1. Populate the new Dropdowns using the existing global data arrays
            const lathSelect = document.getElementById('reportLathType');
            populateDropdown(lathSelect, lathData, 'Name');

            const endlockSelect = document.getElementById('reportEndlockType');
            populateDropdown(endlockSelect, endlockData, 'Description');

            const bottomLathSelect = document.getElementById('reportBottomLathType');
            populateDropdown(bottomLathSelect, bottomLathData, 'Bottom lath name');

            // 2. Motor Filters Setup (Keep existing logic for checkboxes)
            let manufacturerKey = '', voltageKey = '', mountingKey = '';
            if (motorData.length > 0) {
                const firstMotor = motorData[0];
                manufacturerKey = Object.keys(firstMotor).find(k => k.toLowerCase().trim() === 'manufacturer');
                voltageKey = Object.keys(firstMotor).find(k => k.toLowerCase().trim() === 'voltage');
                mountingKey = Object.keys(firstMotor).find(k => k.toLowerCase().trim() === 'mounting type');
            }

            const setupFilterGroup = (containerId, key, data, className) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                if (key) {
                    const uniqueValues = [...new Set(data.map(item => item[key]).filter(val => val))];
                    uniqueValues.sort().forEach(value => {
                        const controlItem = document.createElement('div');
                        controlItem.className = 'admin-control-item';
                        controlItem.innerHTML = `<label><input type="checkbox" class="${className}" value="${value}" checked> ${value}</label>`;
                        container.appendChild(controlItem);
                    });
                } else {
                    container.innerHTML = `<p><em>Column not found in data.</em></p>`;
                }
            };
            
            setupFilterGroup('report-motor-filter-container', manufacturerKey, motorData, 'report-motor-checkbox');
            setupFilterGroup('report-motor-voltage-filter-container', voltageKey, motorData, 'report-voltage-checkbox');
            setupFilterGroup('report-motor-mounting-filter-container', mountingKey, motorData, 'report-mounting-checkbox');

            // Add event listeners for Select/Deselect All buttons (Motors only now)
            document.getElementById('reportMotorSelectAll').addEventListener('click', () => document.querySelectorAll('.report-motor-checkbox').forEach(cb => cb.checked = true));
            document.getElementById('reportMotorDeselectAll').addEventListener('click', () => document.querySelectorAll('.report-motor-checkbox').forEach(cb => cb.checked = false));
            document.getElementById('reportVoltageSelectAll').addEventListener('click', () => document.querySelectorAll('.report-voltage-checkbox').forEach(cb => cb.checked = true));
            document.getElementById('reportVoltageDeselectAll').addEventListener('click', () => document.querySelectorAll('.report-voltage-checkbox').forEach(cb => cb.checked = false));
            document.getElementById('reportMountingSelectAll').addEventListener('click', () => document.querySelectorAll('.report-mounting-checkbox').forEach(cb => cb.checked = true));
            document.getElementById('reportMountingDeselectAll').addEventListener('click', () => document.querySelectorAll('.report-mounting-checkbox').forEach(cb => cb.checked = false));

            // Bind the main generation function
            document.getElementById('generateCsvButton').addEventListener('click', generateCsvReport);
        }

        // --- Updated Headless Calculation Function ---
        // Now accepts Endlock object to calculate combined weight
        function calculateCurtainPropertiesHeadless(lath, bottomLath, endlock, width_mm, height_mm) {
            if (!lath || !bottomLath || height_mm <= 0) {
                return { totalWeight: 0, torqueWeight: 0, travelHeight: 0 };
            }
            
            // 1. Lath Calculation
            const axleRadius = 60; // Estimate
            const lathCompressedHeight = parseFloat(lath['Compressed lath height']);
            const bottomLathHeight = parseFloat(bottomLath['BLath height']) || 0;
            
            const heightToCoverByLaths = (height_mm - bottomLathHeight) + axleRadius;
            let numLaths = (lathCompressedHeight > 0 && heightToCoverByLaths > 0)
                ? Math.ceil(heightToCoverByLaths / lathCompressedHeight) + 2
                : 0;

            const widthM = width_mm / 1000;
            let kgsPerM2 = parseFloat(lath['Kgs/ m2']) || 0;
            
            // Weight based on coverage
            const lathWeightBasedOnCoverage = widthM * (numLaths * lathCompressedHeight / 1000) * kgsPerM2;
            
            // 2. Bottom Lath Weight
            const bottomLathWeight = widthM * (parseFloat(bottomLath['BLath weight / m length']) || 0);
            
            // 3. Endlock Weight Calculation
            let totalEndlockWeight = 0;
            let endlockWeightG = 0;
            if (endlock) {
                const weightKey = Object.keys(endlock).find(k => k.toLowerCase().trim() === 'weight in grams');
                endlockWeightG = weightKey ? parseFloat(endlock[weightKey]) : 0;
                
                if (endlockWeightG > 0 && numLaths > 0) {
                    const numEndlockPairs = Math.ceil(numLaths / 2); 
                    totalEndlockWeight = numEndlockPairs * 2 * (endlockWeightG / 1000);
                }
            }

            // 4. Combined Total Weight
            const totalWeight = lathWeightBasedOnCoverage + bottomLathWeight + totalEndlockWeight;
            
            // 5. Torque Weight (Total minus buffer)
            let torqueWeight = totalWeight;
            if (numLaths >= 3) {
                const bufferLathWeight = 3 * (lathCompressedHeight / 1000) * widthM * kgsPerM2;
                let bufferEndlockWeight = 0;
                if (endlockWeightG > 0) {
                    bufferEndlockWeight = 4 * (endlockWeightG / 1000); // 2 pairs for 3 buffer laths approx
                }
                torqueWeight = totalWeight - bufferLathWeight - bufferEndlockWeight;
            }
            
            const travelHeight = height_mm - bottomLathHeight;
            return { totalWeight, torqueWeight, travelHeight };
        }

        function findBestAxleHeadless(totalWeightKgs, totalLength, fixityPercent) {
             if (totalLength <= 0 || axleData.length === 0) {
                return { name: 'null', status: 'N/A', axleObj: null };
            }
            const axlesForShape = axleData.filter(axle => (axle.Shape || 'circular').toLowerCase().trim() === 'circular');
            if (axlesForShape.length === 0) return { name: 'null', status: 'N/A', axleObj: null };

            let bestAxle = null;
            for (const axle of axlesForShape) {
                const perf = performDeflectionCalc(totalWeightKgs, axle, totalLength, fixityPercent);
                if (perf.ratio >= 400 && perf.deflection <= 25) {
                    bestAxle = axle;
                    break;
                }
            }

            if (bestAxle) {
                return { name: bestAxle.Name, status: 'Pass', axleObj: bestAxle };
            } else {
                return { name: axlesForShape[0].Name, status: 'Fail', axleObj: axlesForShape[0] };
            }
        }
        
        function calculateTorqueHeadless(torqueWeight, lath, travelHeight, axle, width_mm, bottomLath, friction_percent) {
            if (!lath || !axle || !bottomLath || travelHeight <= 0 || torqueWeight <= 0) return 0;
            
            const effectiveStartDiameter = getEffectiveCoilDiameter(axle);
            const bottomLathWeight = (width_mm / 1000) * (parseFloat(bottomLath['BLath weight / m length']) || 0);
            const lathsWeight = torqueWeight - bottomLathWeight;

            const force = (lathsWeight + bottomLathWeight) * 9.81;
            const radiusM = (effectiveStartDiameter / 2) / 1000;
            const maxTorque = force * radiusM;

            const frictionMultiplier = 1 + (friction_percent || 0) / 100;
            return maxTorque * frictionMultiplier;
        }

        async function generateCsvReport() {
            const statusDiv = document.getElementById('csv-generation-status');
            statusDiv.textContent = 'Starting report generation...';
            statusDiv.style.color = 'blue';

            await new Promise(resolve => setTimeout(resolve, 50));

            // --- 1. Get user-defined parameters ---
            const minWidth = parseInt(document.getElementById('reportMinWidth').value);
            const maxWidth = parseInt(document.getElementById('reportMaxWidth').value);
            const minHeight = parseInt(document.getElementById('reportMinHeight').value);
            const maxHeight = parseInt(document.getElementById('reportMaxHeight').value);
            const interval = parseInt(document.getElementById('reportInterval').value);
            const fixityPercent = parseFloat(document.getElementById('axleFixity').value) || 0;
            
            // Get Dropdown Selections
            const lathIndex = document.getElementById('reportLathType').value;
            const endlockIndex = document.getElementById('reportEndlockType').value;
            const bottomLathIndex = document.getElementById('reportBottomLathType').value;
            const collarSize = parseFloat(document.getElementById('collarSize').value) || 0; // Need for rotations

            // Validation
            if (lathIndex === "" || endlockIndex === "" || bottomLathIndex === "") {
                statusDiv.textContent = 'Error: Please select Lath, Endlock, and Bottom Lath types.';
                statusDiv.style.color = 'red';
                return;
            }

            // Get Object Data
            const selectedLath = lathData[lathIndex];
            const selectedEndlock = endlockData[endlockIndex];
            const selectedBottomLath = bottomLathData[bottomLathIndex];

            // Get Motor Filters
            const getSelectedValues = (className) => Array.from(document.querySelectorAll(`.${className}:checked`)).map(cb => cb.value);
            const selectedManufacturers = getSelectedValues('report-motor-checkbox');
            const selectedVoltages = getSelectedValues('report-voltage-checkbox');
            const selectedMountings = getSelectedValues('report-mounting-checkbox');

            if (selectedManufacturers.length === 0 || selectedVoltages.length === 0 || selectedMountings.length === 0) {
                statusDiv.textContent = 'Error: Please select at least one option from each motor filter category.';
                statusDiv.style.color = 'red';
                return;
            }
            
            // Find the correct column keys for motors
            let manufacturerKey = '', voltageKey = '', mountingKey = '';
            if (motorData.length > 0) {
                const firstMotor = motorData[0];
                manufacturerKey = Object.keys(firstMotor).find(k => k.toLowerCase().trim() === 'manufacturer');
                voltageKey = Object.keys(firstMotor).find(k => k.toLowerCase().trim() === 'voltage');
                mountingKey = Object.keys(firstMotor).find(k => k.toLowerCase().trim() === 'mounting type');
            }

            // --- 2. Pre-calculate all data and store in a cache ---
            // Structure: cache[width][height] = { results }
            const calculationCache = {};
            const defaultAdditionalLength = 100;
            let calculationCount = 0;
            
            statusDiv.textContent = `Step 1 of 2: Calculating configuration for ${selectedLath.Name}...`;

            for (let width = minWidth; width <= maxWidth; width += interval) {
                calculationCache[width] = {};
                for (let height = minHeight; height <= maxHeight; height += interval) {
                    calculationCount++;
                    if (calculationCount % 50 === 0) {
                            statusDiv.textContent = `Step 1 of 2: Calculating... (${calculationCount} sizes processed)`;
                            await new Promise(resolve => setTimeout(resolve, 0)); 
                    }

                    const props = calculateCurtainPropertiesHeadless(selectedLath, selectedBottomLath, selectedEndlock, width, height);
                    const totalLength = width + defaultAdditionalLength;
                    
                    // Pass fixityPercent here
                    const axleResult = findBestAxleHeadless(props.totalWeight, totalLength, fixityPercent);
                    
                    const defaultFriction = parseFloat(selectedLath['Friction %']) || 10;
                    
                    const requiredTorque = calculateTorqueHeadless(props.torqueWeight, selectedLath, props.travelHeight, axleResult.axleObj, width, selectedBottomLath, defaultFriction);
                    
                    // Calculate Rotations for Lift Time (if axle found)
                    let totalRotations = 0;
                    if (axleResult.axleObj) {
                        const axleCoilDiameter = getEffectiveCoilDiameter(axleResult.axleObj);
                        const effectiveStartDiameter = Math.max(axleCoilDiameter, collarSize);
                        totalRotations = calculateTotalRevolutions(props.travelHeight, effectiveStartDiameter, parseFloat(selectedLath['Thickness']));
                    }

                    const result = {
                        'Total Weight (kg)': props.totalWeight.toFixed(2),
                        'Required Axle Name': axleResult.name,
                        'Axle Deflection Status': axleResult.status,
                        'Max Required Torque (Nm)': requiredTorque > 0 ? requiredTorque.toFixed(1) : 'null'
                    };

                    // Calculate motor for each scenario
                    for (const man of selectedManufacturers) {
                        for (const vol of selectedVoltages) {
                            for (const mou of selectedMountings) {
                                const scenarioKey = `Motor: ${man} (${vol}, ${mou})`;
                                const timeKey = `Lift Time: ${man} (${vol}, ${mou})`; // New Key for Time

                                const suitableMotors = motorData
                                    .filter(m => 
                                        m[manufacturerKey] == man &&
                                        String(m[voltageKey]) == String(vol) &&
                                        m[mountingKey] == mou &&
                                        requiredTorque > 0 && 
                                        requiredTorque >= parseFloat(m['Torque (Nm) min']) && 
                                        requiredTorque <= parseFloat(m['Torque (Nm) max'])
                                    )
                                    .sort((a,b) => parseFloat(a['Torque (Nm) max']) - parseFloat(b['Torque (Nm) max']));
                                
                                if (suitableMotors.length > 0) {
                                    const selectedMotor = suitableMotors[0];
                                    result[scenarioKey] = selectedMotor.Name;
                                    
                                    // Calculate Lift Time
                                    const rpm = parseFloat(selectedMotor['RPM']);
                                    if (rpm > 0 && totalRotations > 0) {
                                        const timeSec = (totalRotations / rpm) * 60;
                                        result[timeKey] = timeSec.toFixed(1) + 's';
                                    } else {
                                        result[timeKey] = 'N/A';
                                    }

                                } else {
                                    result[scenarioKey] = 'null';
                                    result[timeKey] = 'N/A';
                                }
                            }
                        }
                    }
                    calculationCache[width][height] = result;
                }
            }

            // --- 3. Build the CSV output from the cached data ---
            statusDiv.textContent = 'Step 2 of 2: Assembling CSV file...';
            await new Promise(resolve => setTimeout(resolve, 0));

            const csvData = [];
            const widthHeaders = ['Height \\ Width'];
            for (let w = minWidth; w <= maxWidth; w += interval) {
                widthHeaders.push(w);
            }

            // Determine the table keys from the first calculated entry
            const firstEntry = calculationCache[minWidth][minHeight];
            const tableTypes = Object.keys(firstEntry);

            for (const tableType of tableTypes) {
                // Add table title
                csvData.push([`Lath: ${selectedLath.Name} | Endlock: ${selectedEndlock['Description']} | Bottom Lath: ${selectedBottomLath['Bottom lath name']} | Fixity: ${fixityPercent}%`]);
                csvData.push([`Data: ${tableType}`]);
                
                // Add width headers
                csvData.push(widthHeaders);

                // Add data rows
                for (let height = minHeight; height <= maxHeight; height += interval) {
                    const row = [height];
                    for (let width = minWidth; width <= maxWidth; width += interval) {
                        const value = calculationCache[width]?.[height]?.[tableType] || 'N/A';
                        row.push(value);
                    }
                    csvData.push(row);
                }

                // Add spacer rows between tables
                csvData.push([]);
                csvData.push([]);
            }

            // --- 4. Trigger Download ---
            downloadCsv(csvData);
            statusDiv.textContent = 'Report generation complete. Download has started.';
            statusDiv.style.color = 'green';
        }

        function downloadCsv(data) {
            let csvContent = "data:text/csv;charset=utf-8,";
            data.forEach(function(rowArray) {
                let row = rowArray.map(item => `"${String(item).replace(/"/g, '""')}"`).join(",");
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "shutter_calculator_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
    <!-- =================================================================== -->
    <!-- END:   CODE FOR CSV REPORT GENERATION (UPDATED)                     -->
    <!-- =================================================================== -->
</body>
</html>
